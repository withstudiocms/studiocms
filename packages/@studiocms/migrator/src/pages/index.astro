---
import { Button } from 'studiocms:ui/components/button';
import { Card } from 'studiocms:ui/components/card';
import { Divider } from 'studiocms:ui/components/divider';
import { TabItem, Tabs } from 'studiocms:ui/components/tabs';
import { runEffect } from '@withstudiocms/effect';
import type { ComponentProps } from 'astro/types';
import ErrorCard from '../components/ErrorCard.astro';
import MigrationStatus from '../components/MigrationStatus.astro';
import StatusTables from '../components/StatusTables.astro';
import { searchTables } from '../db/astrodb.js';
import {
	getDataMigrationStatus,
	getDialectFromEnv,
	runConnectionTest,
	studioCMSDbMigrator,
} from '../db/client.js';
import Layout from '../layouts/Layout.astro';
import { getErrorCases } from '../lib/errors.js';
import { astroDbTableKeys } from '../lib/tableMap.js';

// AstroDB Tables
const astroDBTables = await searchTables('StudioCMS%');

// Test StudioCMS DB Connection
const isStudioCMSDbConnected = await runConnectionTest();

// StudioCMS Schema Migrations
const migrator = await studioCMSDbMigrator();
const migrationStatus = await runEffect(migrator.status).catch(() => []);
const migrationTotal = migrationStatus.length;
const appliedMigrations = migrationStatus.filter((m) => m.executedAt).length;

// Data Migration Status
const dataMigrationStatus = await getDataMigrationStatus();

// Determine Error Cases
const errorCases = getErrorCases({
	astroDBTables,
	astroDbTableKeys,
	appliedMigrations,
	migrationTotal,
	dataMigrationStatus,
});

// Prepare Database Status Tables
const dbStatusTables: ComponentProps<typeof StatusTables>['dbStatusTables'] = [
	{
		label: 'AstroDB Database',
		conditions: [
			{
				label: 'Connection Status',
				value: astroDBTables.length > 0 ? 'Connected' : 'Not Connected',
				color: astroDBTables.length > 0 ? 'success' : 'danger',
			},
			{
				label: 'Required Tables',
				value:
					astroDBTables.length >= astroDbTableKeys.length
						? 'Available'
						: `Missing ${astroDbTableKeys.length - astroDBTables.length} Tables`,
				color: astroDBTables.length >= astroDbTableKeys.length ? 'success' : 'danger',
			},
		],
	},
	{
		label: 'StudioCMS Database',
		conditions: [
			{
				label: 'Connection Status',
				value: isStudioCMSDbConnected ? 'Connected' : 'Not Connected',
				color: isStudioCMSDbConnected ? 'success' : 'danger',
			},
			{
				label: 'Dialect',
				value: getDialectFromEnv(),
				color: 'info',
			},
			{
				label: 'Schema Migration Status',
				value: appliedMigrations === migrationTotal ? 'Latest' : 'Pending Migrations',
				color: appliedMigrations === migrationTotal ? 'success' : 'danger',
			},
			{
				label: 'Data Migration Status',
				value: dataMigrationStatus.canMigrate ? 'Available' : 'Not Available',
				color: dataMigrationStatus.canMigrate ? 'success' : 'danger',
			},
		],
	},
];
---
<Layout title="StudioCMS Migrator">

    {
        errorCases
            .filter((error) => error.condition)
            .map(({ title, description }) => (
                <ErrorCard {title} {description} />
            ))
    }

    <Card fullWidth class="db-status-card" variant='filled'>

        <div slot="header">
            <h2>Database Status Overview</h2>
        </div>

        <div class="split-screen">

            <StatusTables {dbStatusTables} />

        </div>

        <span class="divider-holder"><Divider /></span>

        <h2>Migration Actions</h2>

        <Tabs variant='starlight'>

            <TabItem label='Schema Migrations'>

                <div class="button-shelf">
                    <Button 
                        id='run-migrations-button'
                        variant='solid' 
                        color='primary'
                        size="md"
                        disabled={appliedMigrations === migrationTotal}
                        >Run Schema Migrations
                    </Button>
                </div>

                <MigrationStatus {migrationStatus} />
            </TabItem>

            <TabItem label='Migrate Data'>
                <p>TODO</p>
            </TabItem>

        </Tabs>

    </Card>

    <script>
        import { toast } from 'studiocms:ui/components/toaster/client';
        const $ = (selector: string) => document.querySelector(selector);

        const migrationsButton = $('#run-migrations-button') as HTMLButtonElement | null;

        function resetMigrationButton() {
            if (migrationsButton) {
                migrationsButton.disabled = false;
                migrationsButton.textContent = 'Run Schema Migrations';
            }
        };

        migrationsButton?.addEventListener('click', async () => {
            migrationsButton.disabled = true;
            migrationsButton.textContent = 'Running Migrations...';

            try {
                const response = await fetch('/schema-migrations', {
                    method: 'POST',
                });

                if (response.ok) {
                    toast({
                        title: 'Schema Migrations Applied',
                        description: 'All pending schema migrations have been successfully applied.',
                        type: 'success',
                    })

                    setTimeout(() => {
                        window.location.reload();
                    }, 6000);
                } else {
                    const errorData = await response.json();
                    toast({
                        title: 'Error Applying Migrations',
                        description: errorData.error,
                        type: 'danger',
                    });
                    resetMigrationButton();
                }
            } catch (error) {
                toast({
                    title: 'Network Error',
                    description: String(error),
                    type: 'danger',
                });
                resetMigrationButton();
            }
        });
    </script>

</Layout>