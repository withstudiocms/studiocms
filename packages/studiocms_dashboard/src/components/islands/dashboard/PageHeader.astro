---
import { logger } from '@it-astro:logger:studiocms-dashboard';
import { getUserData, verifyUserPermissionLevel } from 'studiocms:auth/lib/user';
import { StudioCMSRoutes } from 'studiocms:helpers/routemap';
import { getLangFromUrl, useTranslations } from 'studiocms:i18n';
import DiscordLogo from '@studiocms/assets/svgs/discord.svg?raw';
import { Button } from '@studiocms/ui/components';
import Icon from '@studiocms/ui/utils/Icon.astro';
import { default as PageHead } from '../../PageHeader.astro';

const user = await getUserData(Astro);

if (!user.user) {
	return Astro.redirect(StudioCMSRoutes.authLinks.loginURL);
}

const referer = Astro.request.headers.get('referer');

if (!referer) {
	throw new Error('No referer found');
}

const lang = getLangFromUrl(new URL(referer));
const t = useTranslations(lang, '@studiocms/dashboard:index');

// Check Permission Level
if (!verifyUserPermissionLevel(user, 'editor')) {
	logger.info('User is not an admin or editor. Redirecting to profile page.');
	return Astro.redirect(StudioCMSRoutes.mainLinks.userProfile);
}
---
<PageHead
title={`${t("welcome-title")}, ${user.user.name}`}
>
<Button color='primary' variant='flat' as="a" href={'https://chat.studiocms.dev'} target='_blank' rel='noreferrer,noopener'>
  <Fragment set:html={DiscordLogo} slot='start-content' />
  {t("title-button:discord")}
</Button>
<Button color='success' variant='flat'>
  <Icon name='chat-bubble-oval-left-ellipsis' width={24} height={24} />
  {t("title-button:feedback")}
</Button>
</PageHead>