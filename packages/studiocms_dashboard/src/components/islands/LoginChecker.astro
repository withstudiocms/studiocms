---
import { getUserData, verifyUserPermissionLevel } from 'studiocms:auth/lib/user';
import { StudioCMSRoutes } from 'studiocms:lib';

interface Props {
	requiredPermission: 'owner' | 'admin' | 'editor' | 'visitor' | 'unknown';
}

const { requiredPermission } = Astro.props;

const user = await getUserData(Astro);

const isAuthorized = await verifyUserPermissionLevel(user, requiredPermission);
---

<div 
    id="login-checker"
    style="display: hidden;" 
    data-is_logged_in={`${user.isLoggedIn}`}
    data-authorized={`${isAuthorized}`} 
    data-redirect_profile={StudioCMSRoutes.mainLinks.userProfile}
    data-redirect_login={StudioCMSRoutes.authLinks.loginURL}
/>

<script>
    function check() {
        const authorized = document.getElementById('login-checker') as HTMLDivElement;

        if (window.location.pathname === authorized.dataset.redirect_profile) {
            return;
        }

        if (authorized.dataset.is_logged_in === 'false') {
            window.location.href = authorized.dataset.redirect_login!;
        }

        if (authorized.dataset.authorized === 'false') {
            window.location.href = authorized.dataset.redirect_profile!;
        }
    }

    check();

    document.addEventListener('astro:page-load', check);
</script>

