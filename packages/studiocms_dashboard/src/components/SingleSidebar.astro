---
import { useTranslations } from 'studiocms:i18n';
import { StudioCMSRoutes } from 'studiocms:lib';
import { Divider, Dropdown, Sidebar, User } from '@studiocms/ui/components';
import StudioCMSLogo from '../components/StudioCMSLogo.astro';
import SidebarLink from './SidebarLink.astro';
import Admin from './islands/sidebar/Admin.astro';
import UserAccount from './islands/sidebar/UserAccount.astro';

const lang = 'en-us';
const t = useTranslations(lang, '@studiocms/dashboard:sidebar');
---

<Sidebar class='sidebar' transition:persist transition:persist-props>
  <div class="sidebar-links-container">
    <div class="sidebar-header">
      <StudioCMSLogo class={'sidebar-logo'} />
      <span class="sidebar-title">StudioCMS</span>
    </div>
    <Divider background='background-step-1'>{t("category-1-header")}</Divider>
    <div class="sidebar-link-group">
      <SidebarLink icon='home' href={'/dashboard/'}>
        {t("dashboard-link-label")}
      </SidebarLink>
      <SidebarLink icon='pencil-square' href={'/dashboard/test'}>
        {t("content-management-label")}
      </SidebarLink>
    </div>
    <Admin server:defer transition:persist transition:persist-props>
      <span slot="fallback">Loading</span>
    </Admin>
  </div>
  <Dropdown 
    id='sidebar-user-dropdown'
    options={[
      { label: t("user-dropdown:settings"), value: 'user-settings', icon: "user", href: StudioCMSRoutes.mainLinks.userProfile },
      { label: t("user-dropdown:view-site"), value: 'view-site', icon: "globe-alt", href: StudioCMSRoutes.mainLinks.baseSiteURL },
      { label: t("user-dropdown:logout"), value: 'log-out', icon: "arrow-left-start-on-rectangle", href: StudioCMSRoutes.authLinks.logoutURL },
    ]}
    offset={8}
    transition:persist transition:persist-props
  >
    <div class="user-dropdown-trigger-container">
      <UserAccount server:defer transition:persist transition:persist-props>
        <User slot="fallback" name={"Visitor"} description={'Unknown'} />
      </UserAccount>
    </div>
  </Dropdown>
</Sidebar>

<script>
  import { SingleSidebarHelper } from "@studiocms/ui/components";
  import { DropdownHelper } from "@studiocms/ui/components";

  console.log('Setting up sidebar');

  document.addEventListener('astro:page-load', () => {
    console.log('Page loaded');
    new SingleSidebarHelper('nav-toggle');
    new DropdownHelper('sidebar-user-dropdown', true);

    console.log('Setting active link');
    const sidebar = document.querySelector<HTMLElement>('.sidebar')!;
    const sidebarLinks = sidebar.querySelectorAll<HTMLAnchorElement>('a');
      
    for (const link of sidebarLinks) {
      link.classList.remove('active');
      if (window.location.pathname === new URL(link.href).pathname) {
        link.classList.add('active');
      }
    }
  });
</script>
<style>
  .sidebar-link-group {
    display: flex;
    flex-direction: column;
    gap: .375rem;
    width: 100%;
  }

  .sidebar-link-group.hidden {
    display: none;
  }

  .empty-placeholder-span {
    width: 100%;
    text-align: center;
    color: hsl(var(--text-muted));
    font-size: .875em;
  }

  .user-dropdown-trigger-container {
    width: calc(280px - 3rem);
    cursor: pointer;
    border: 1px solid hsl(var(--border));
    padding: .5rem;
    border-radius: .5rem;
    transition: all .15s ease;
  }

  .user-dropdown-trigger-container:hover {
    background-color: hsla(var(--border), .5);
  }

  .sidebar {
    justify-content: space-between;
  }

  .sidebar-links-container {
    gap: .75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
</style>
