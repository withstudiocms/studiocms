---
import { StudioCMSRoutes } from 'studiocms:helpers/routemap';
import { getLangFromUrl, useTranslatedPath, useTranslations } from 'studiocms:i18n';
import { Divider, Dropdown, Sidebar, User } from '@studiocms/ui/components';
import StudioCMSLogo from '../components/StudioCMSLogo.astro';
import SidebarLink from './SidebarLink.astro';
import Admin from './islands/sidebar/Admin.astro';
import UserAccount from './islands/sidebar/UserAccount.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang, '@studiocms/dashboard:sidebar');
const tPath = useTranslatedPath(lang);
---

<Sidebar class='sidebar' transition:persist transition:persist-props>
  <div class="sidebar-links-container">
    <div class="sidebar-header">
      <StudioCMSLogo class={'sidebar-logo'} />
      <span class="sidebar-title">StudioCMS</span>
    </div>
    <Divider background='background-step-1'>{t("category-1-header")}</Divider>
    <div class="sidebar-link-group">
      <SidebarLink icon='home' href={tPath('/dashboard')}>
        {t("dashboard-link-label")}
      </SidebarLink>
      <SidebarLink icon='pencil-square' href={tPath('/dashboard/test')}>
        {t("content-management-label")}
      </SidebarLink>
    </div>
    <Admin server:defer transition:persist transition:persist-props>
      <span slot="fallback">Loading</span>
    </Admin>
  </div>
  <Dropdown
    id='sidebar-user-dropdown'
    options={[
      { label: t("user-dropdown:settings"), value: 'user-settings', icon: "user" },
      { label: t("user-dropdown:view-site"), value: 'view-site', icon: "globe-alt" },
      { label: t("user-dropdown:logout"), value: 'log-out', icon: "arrow-left-start-on-rectangle" },
    ]}
    offset={8}
    transition:persist transition:persist-props
  >
    <div class="user-dropdown-trigger-container">
      <UserAccount server:defer transition:persist transition:persist-props>
        <User slot="fallback" name={"Visitor"} description={'Unknown'} />
      </UserAccount>
    </div>
  </Dropdown>
</Sidebar>

<div style="display: none;" 
  id="dropdown-options" 
  data-usersettings={tPath(StudioCMSRoutes.mainLinks.userProfile)} 
  data-viewsite={tPath(StudioCMSRoutes.mainLinks.baseSiteURL)}
  data-logout={tPath(StudioCMSRoutes.authLinks.logoutURL)}
  />

<script>
  import { SingleSidebarHelper } from "@studiocms/ui/components";
  import { DropdownHelper } from "@studiocms/ui/components";

  document.addEventListener('astro:page-load', () => {
    new SingleSidebarHelper('nav-toggle');
    new DropdownHelper('sidebar-user-dropdown', true);

    // Get the dropdown list items
    const dropdownListItems = document.querySelector<HTMLUListElement>('#sidebar-user-dropdown-dropdown')!.querySelectorAll<HTMLLIElement>('li');

    // Get the dropdown options (URLs for each dropdown item)
    const { dataset: linkData } = document.querySelector<HTMLDivElement>('#dropdown-options')!;

    // Create a record of links (key: dropdown item value, value: URL)
    const links: Record<string, string> = {
      'user-settings': linkData.usersettings!,
      'view-site': linkData.viewsite!,
      'log-out': linkData.logout!,
    };

    for (const item of dropdownListItems) {
      item.addEventListener('click', () => {
        const value = item.dataset.value!;

        window.location.href = `${links[value]}`;
      })
    }

    const sidebar = document.querySelector<HTMLElement>('.sidebar');

    if (!sidebar) return;
    
    const sidebarLinks = sidebar.querySelectorAll<HTMLAnchorElement>('a');
      
    for (const link of sidebarLinks) {
      link.classList.remove('active');
      if (window.location.pathname === new URL(link.href).pathname) {
        link.classList.add('active');
      }
    }
  });
</script>
<style>
  .sidebar-link-group {
    display: flex;
    flex-direction: column;
    gap: .375rem;
    width: 100%;
  }

  .sidebar-link-group.hidden {
    display: none;
  }

  .empty-placeholder-span {
    width: 100%;
    text-align: center;
    color: hsl(var(--text-muted));
    font-size: .875em;
  }

  .user-dropdown-trigger-container {
    width: calc(280px - 3rem);
    cursor: pointer;
    border: 1px solid hsl(var(--border));
    padding: .5rem;
    border-radius: .5rem;
    transition: all .15s ease;
  }

  .user-dropdown-trigger-container:hover {
    background-color: hsla(var(--border), .5);
  }

  .sidebar {
    justify-content: space-between;
  }

  .sidebar-links-container {
    gap: .75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
</style>
