---
import { getUserData } from 'studiocms:auth/lib/user';
import { FormattedDate } from 'studiocms:components';
import { StudioCMSRoutes } from 'studiocms:lib';
import studioCMS_SDK from 'studiocms:sdk';
import { Button, Card, Center, Group, Icon, Input, Modal, Select } from 'studiocms:ui/components';
import Layout from '../../components/Layout.astro';
import PageHeader from '../../components/PageHeader.astro';
import { providerData, showOAuth } from '../../components/islands/profile/oAuthButtonProviders';
import InnerSidebarElement from '../../components/islands/user-mgmt/InnerSidebarElement.astro';
import RankCheck from '../../components/islands/user-mgmt/RankCheck.astro';
import SocialSignin from '../../components/islands/user-mgmt/SocialSignin.astro';

const lang = 'en-us';

const urlParams = Astro.url.searchParams;
const userId = urlParams.get('user') || '';

const user = await studioCMS_SDK.GET.databaseEntry.users.byId(userId);

const shouldShowOAuth = showOAuth && providerData.some(({ enabled }) => enabled);

const { user: loggedInUser } = await getUserData(Astro);

const disableDelete = user?.permissionsData?.rank === 'owner' || user?.id === loggedInUser?.id;
---
<Layout 
  title="User Management"
  requiredPermission='admin'
  sidebar='double'
  {lang}
  >
  {/*
    Check if the user has the required permission to manage the user's rank level
  */}
  <RankCheck requiredPermission={user?.permissionsData?.rank} />

  <div slot="double-sidebar" class="inner-sidebar-container">
    <div class="sidebar-user-links-container">
      <InnerSidebarElement />
    </div>
  </div>

  <div slot="header">
    <PageHeader title={user?.name || 'User Management'}>

      <Group>
        <Button id="delete-user-modal-trigger" color="danger" type="submit" size="sm" disabled={disableDelete} data-action={StudioCMSRoutes.endpointLinks.users}>
          <Icon name="trash-20-solid" width={20} height={20} />
          Delete
        </Button>
        <Button id="edit-user-button" variant="solid" size="sm"  color="primary" type="submit" form="edit-user-form">
          <Icon slot="start-content" name="check-20-solid" width={20} height={20} />
          Save Changes
        </Button>
      </Group>

      <Modal
        id="delete-user-modal"
        isForm
        cancelButton={{ label: 'Cancel', color: 'default' }}
        actionButton={{ label: 'Delete', color: 'danger' }}
        >
        <h2 slot="header">Are you sure you want to delete this user?</h2>
        <Center>
          <div class="modal-body">
            <input type="hidden" name="user-id" value={userId} />
            <input type="hidden" name="user-username" value={user?.username} />

            <span>Enter the user name <code>{user?.username}</code> to confirm</span>

            <Input name="confirm-user-username" placeholder={`${user?.username.slice(0, user?.username.length-2)}...`} isRequired />
          
            <span style="color: hsl(var(--danger-base))">This action cannot be undone.</span>
          </div>
        </Center>
      </Modal>

    </PageHeader>
  </div>

  <div id="edit-user-container">

    <div class="text-h3">User Information</div>

    <Card class="user-information-block" fullWidth variant={'filled'}>
      <table>
        <tr> <td>Email</td> <td>{user?.email}</td> </tr>
        <tr> <td>Username</td> <td>{user?.username}</td> </tr>
        {user?.url && <tr> <td>Website</td> <td>{user?.url}</td> </tr> }
        <tr> <td>Created at</td> <td><FormattedDate date={user?.createdAt!} /></td> </tr>
        { user?.updatedAt && <tr> <td>Last Updated</td> <td><FormattedDate date={user?.updatedAt} /></td> </tr> }
      </table>
    </Card>

    <div>
      <Button id="password-reset-link-trigger" variant={'outlined'} color={'danger'} size="sm" disabled={disableDelete}>
        <Icon name="lock-open-20-solid" width={20} height={20} />
        Create Reset Link
      </Button>
      <Modal id='password-reset-link-modal'>
        <h2 slot="header">Reset Password Link</h2>
        <Center>
          <div class="modal-body">
            <span>Reset link for user <code>{user?.username}</code> has been created.</span>
            <span>Link: </span>
            <code id="reset-link-placeholder"></code>
          </div>
        </Center>
      </Modal>
    </div>

    <form id="edit-user-form" action={StudioCMSRoutes.endpointLinks.users}>

      <div class="text-h3">Role</div>

      <input type="hidden" name="user-id" value={user?.id}>

      <Select 
        name="rank"  
        isRequired 
        fullWidth 
        defaultValue={user?.permissionsData?.rank || 'visitor'}
        options={[
          { label: 'Owner', value: 'owner' },
          { label: 'Administrator', value: 'admin' },
          { label: 'Editor', value: 'editor' },
          { label: 'Visitor', value: 'visitor' },
        ]}
        />

    </form>

    { shouldShowOAuth && ( 
      <SocialSignin oAuthData={user?.oAuthData} />
    )}
  </div>

  <div style="display: none;" id="reset-link-selector" data-link={StudioCMSRoutes.endpointLinks.createResetLink} data-userid={user?.id} data-dashboard={StudioCMSRoutes.mainLinks.dashboardIndex}></div>

  <script>
    import { ModalHelper, toast } from 'studiocms:ui/components';

    const resetLinkModal = new ModalHelper('password-reset-link-modal');

    const passwordResetLinkTrigger = document.getElementById('password-reset-link-trigger') as HTMLButtonElement;
    const resetLinkPlaceholder = document.getElementById('reset-link-placeholder') as HTMLElement;

    const resetLinkAPI = (document.getElementById('reset-link-selector') as HTMLDivElement).dataset.link;
    const userId = (document.getElementById('reset-link-selector') as HTMLDivElement).dataset.userid;
    const dashboardIndex = (document.getElementById('reset-link-selector') as HTMLDivElement).dataset.dashboard;

    function generateResetLink(token: {
      id: string;
      userId: string;
      token: string;
    }) {
      return `${window.location.origin}${dashboardIndex}/reset-password?userid=${token.userId}&token=${token.token}&id=${token.id}`;
    }

    passwordResetLinkTrigger.addEventListener('click', async (e) => {
      e.preventDefault();

      const apiRes = await fetch(resetLinkAPI!, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId: userId })
      });

      const token = await apiRes.json();

      if (!apiRes.ok) {
        console.error('Failed to create reset link');
        toast({
          title: 'Error',
          description: token.error,
          type: 'danger'
        })
        return;
      }

      resetLinkPlaceholder.innerText = generateResetLink(token);

      resetLinkModal.show();
    })

    const editUserForm = document.getElementById('edit-user-form') as HTMLFormElement;

    const deleteUserAction = (document.getElementById('delete-user-modal-trigger') as HTMLButtonElement).dataset.action;

    const userDeleteModal = new ModalHelper('delete-user-modal', 'delete-user-modal-trigger');
    
    userDeleteModal.registerConfirmCallback(async (formData) => {
      if (!formData) {
        console.error('No form data provided') 
        return
      };

      const data = {
        userId: formData.get('user-id')?.toString(), 
        username: formData.get('user-username')?.toString(), 
        usernameConfirm: formData.get('confirm-user-username')?.toString()
      }

      const response = await fetch(deleteUserAction!, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })

      const res = await response.json();

      if (response.status !== 200) {
        toast({
          title: 'Error',
          description: res.error,
          type: 'danger'
        })
      }

      if (response.status === 200) {
        toast({
          title: 'Success',
          description: res.message,
          type: 'success'
        })
      }
    })

    editUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(editUserForm);

      const data = {
        id: formData.get('user-id')?.toString(),
        rank: formData.get('rank')?.toString(),
      }

      const response = await fetch(editUserForm.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })

      const res = await response.json();

      if (response.status !== 200) {
        toast({
          title: 'Error',
          description: res.error,
          type: 'danger'
        })
      }

      if (response.status === 200) {
        toast({
          title: 'Success',
          description: res.message,
          type: 'success'
        })
      }
    })
  </script>

</Layout>

<style>

  .sidebar-user-links-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    height: 100%;
  }

  .inner-sidebar-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    height: 100%;
    width: 100%;
    padding-top: 1rem;
    padding-bottom: 1rem;
    background-color: hsl(var(--background-base));
  }

  .placeholder-info {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 40vh;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 30vh;
    z-index: -1;

    p {
      font-size: 1.25rem;
      color: hsl(var(--text-muted));
    }
  }

  #edit-user-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #edit-user-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }

  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;

    span {
        font-size: .875rem;
    }

    code {
        background-color: hsl(var(--background-step-3));
        padding: .25rem;
        border-radius: 4px;
    }
  }

  #password-reset-link-modal {

    & .modal-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;

      span {
        font-size: .875rem;
      }

      code {
        background-color: hsl(var(--background-step-3));
        padding: .25rem;
        border-radius: 4px;
      }
    }
  }

  table {
    width: 100%;
    border-collapse: collapse;

    tr {
      border-bottom: 2px solid hsl(var(--background-step-1));
    }

    tr:nth-child(even) {
      background-color: hsl(var(--background-step-2));
    }

    tr:last-child {
      border-bottom: none;
    }

    td {
      padding: .5rem;
    }
  }
</style>
