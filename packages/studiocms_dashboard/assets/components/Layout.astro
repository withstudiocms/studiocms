---
import { studioCMS_SDK_Cache } from 'studiocms:sdk/cache';
import { Button, Toaster } from '@studiocms/ui/components';
import Icon from '@studiocms/ui/utils/Icon.astro';
import { BaseHead } from '../components';
import { makePageTitle } from '../utils';
import DoubleSidebar from './DoubleSidebar.astro';
import Footer from './Footer.astro';
import SingleSidebar from './SingleSidebar.astro';
import LoginChecker from './islands/LoginChecker.astro';

const { data: dbConfig } = await studioCMS_SDK_Cache.GET.siteConfig();

type Props = {
	title: string;
	pagePreRendered?: boolean;
	description?: string;
	lang?: string;
	sidebar?: false | 'single' | 'double';
	requiredPermission?: 'owner' | 'admin' | 'editor' | 'visitor' | 'unknown' | 'none';
	footer?: boolean;
};

const {
	title: propTitle,
	description: propDescription,
	pagePreRendered = true,
	lang = 'en-us',
	requiredPermission = 'unknown',
	sidebar = 'single',
	footer = true,
} = Astro.props;

const title = makePageTitle(propTitle, dbConfig);
const description = propDescription ?? dbConfig.description;
---

<!DOCTYPE html>
<html {lang}>
  <BaseHead {title} {description} />
  <body>
    <Toaster />
    { requiredPermission !== 'none' && ( 
      <> { pagePreRendered 
        ? <LoginChecker requiredPermission={requiredPermission} server:defer /> 
        : <LoginChecker requiredPermission={requiredPermission} /> 
      } </>
     ) }
    { sidebar === 'single' && <SingleSidebar {pagePreRendered} /> }
    { sidebar === 'double' && <DoubleSidebar {pagePreRendered}><slot name="double-sidebar" /></DoubleSidebar> }

    <main>
      { sidebar !== false && (
        <Button variant="outlined" color="primary" class="nav-toggle" id={'nav-toggle'}>
          <Icon name="bars-3" height={24} width={24} />
        </Button> )}
      <div class="container">

        <div class="page-header">
          <slot name="header" />
        </div>

        <div class="container-content">
          <slot />
        </div>

        { footer && <Footer /> }

      </div>
    </main>
  </body>
</html>
