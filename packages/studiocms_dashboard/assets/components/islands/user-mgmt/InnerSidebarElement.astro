---
import { StudioCMSRoutes } from 'studiocms:lib';
import studioCMS_SDK from 'studiocms:sdk';
import { Button, Divider, Dropdown, Icon, Input } from 'studiocms:ui/components';
import UserListItem from './UserListItem.astro';

const Users = await studioCMS_SDK.GET.database.users();

const safeUsers: {
	id: string;
	name: string;
	email: string | null;
	avatar: string | null;
	username: string;
	permissionsData:
		| {
				user: string;
				rank: string;
		  }
		| undefined;
}[] = Users.map(({ avatar, email, id, name, username, permissionsData }) => {
	return { avatar, email, id, name, username, permissionsData };
});
---
<div class="inner-user-sidebar-header">
    <form id="search-form">
      <Input name='search' placeholder='Search...' type='search' required />
    </form>
    <Dropdown
      transition:persist
      transition:persist-props
      id='create-user-dropdown'
      options={[
      ]}
      align={'end'}
      offset={8}
      >
      <Button variant="solid" color="primary" size='sm' class="add-button">
      <Icon name="plus" width={24} height={24} />
      </Button>
    </Dropdown>
</div>

<Divider background={'background-step-1'}></Divider>

<div id="user-list"
    class="inner-sidebar-users scrollbar" 
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
    { Users.map((user) => <UserListItem user={user} />) }
</div>

<div id="search-list"
    class="inner-sidebar-users scrollbar" 
    style="display: none;"
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
</div>

<script>
    import { DropdownHelper } from 'studiocms:ui/components';
  
    function setupDropdown() {
        const createNewDropdown = new DropdownHelper('create-user-dropdown');
    
        createNewDropdown.registerClickCallback((value) => {
            window.location.assign(value);
        });
    };
  
    document.addEventListener('astro:page-load', setupDropdown);
    setupDropdown();
</script>

<script>
    import DOMPurify from "dompurify";
    import Fuse from "fuse.js";

    type User = {
            id: string;
            name: string;
            email: string | null;
            avatar: string | null;
            username: string;
            permissionsData:
                | {
                        user: string;
                        rank: string;
                }
                | undefined;
        };

    type Users = User[];

    function clearSearchParams(userListElm: HTMLDivElement, ActualList: HTMLDivElement) {
        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        window.history.pushState({}, '', url);
        userListElm.style.display = 'none';
        ActualList.style.display = 'flex';
    }

    async function runSearch(form: HTMLFormElement, userListElm: HTMLDivElement, users: Users, userListItemsPartial: string, ActualList: HTMLDivElement) {
        const formData = new FormData(form);
        
        const searchTerm = DOMPurify.sanitize(formData.get('search')?.toString() || '');

        if (!searchTerm || searchTerm.length === 0) return;

        const url = new URL(window.location.href);
        url.searchParams.set('search', searchTerm);
        window.history.pushState({}, '', url);

        const searchList = users;

        const fuse = new Fuse(searchList, {
            keys: ['name', 'username'],
            isCaseSensitive: false,
            threshold: 0.5,
        });

        const results = fuse.search(searchTerm);

        const res = await fetch(userListItemsPartial, {
            method: 'POST',
            body: JSON.stringify({ users: results.map((item) => item.item), searchQuery: searchTerm }),
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!res.ok) {
            console.error('Failed to fetch search list');
            return [];
        }

        const html = await res.text();

        userListElm.innerHTML = html;
        userListElm.style.display = 'flex';
        ActualList.style.display = 'none';
    }

    async function searchSetup() {
        const searchForm = document.getElementById('search-form') as HTMLFormElement;
        const searchInput = searchForm.querySelector('input[name="search"]') as HTMLInputElement;

        const ActualUserList = document.querySelector('#user-list') as HTMLDivElement;
        
        const userListElm = document.querySelector('#search-list') as HTMLDivElement;
        const users: Users = JSON.parse(userListElm.dataset.users || '[]');
        const userListItemsPartial = userListElm.dataset.userpartial!;

        const url = new URL(window.location.href);

        const searchTerm = url.searchParams.get('search');

        if (searchTerm) {
            const input = searchInput;
            input.value = searchTerm;
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        });

        let timeout: NodeJS.Timeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(async () => await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList), 500);
        });

        searchInput.addEventListener('search', () => {
            clearSearchParams(userListElm, ActualUserList);
        });
    }

document.addEventListener('astro:page-load', searchSetup);
</script>

<style>

.inner-user-sidebar-header {
	display: flex;
	width: 100%;
	justify-content: space-between;
	align-items: center;
    padding-bottom: 1rem;
    padding-left: 1rem;
    padding-right: 1rem;

	& input {
		margin-right: 1rem;
		width: 95%;
	}

	& .add-button {
		width: 32px !important;
		height: 32px !important;
		padding: 0.25rem !important;
	}

	& input[name="search"] {
		/* heroicons:magnifying-glass-16-solid */
		background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAndJREFUSEvFlUtoFEEQhv/qRVkvevARiM+DiOAjKooS0KCYg9EIigrGi3jzIBK8bNdsCIHt3mURET14EwQhugQRIxg8KMRHEIMGQUFyCCiBGFBE8LLsdLkTZsUkm52BZLGuXV3f/FX19xDqHFTn+vh/gO7u7sXJZPK0iFwAsAnASgBjRDTsnOsvFot9PT09LqoDVRVkMpnVSqkBAFtrFBgBcI6ZP9WCzAIYYxqI6B2AxvDiGxEZSCQS733f30lEbQD2hGcTzrnd6XR6fC7INICIUDabfQ6gBcAkgIvM/GDmZWvtKRG5RUQrAAwxc3MsgDGmlYieBslEdERrHbSpahhjjhLR4zC3Q2vdWy1xmgJr7X0AZwA8ZOYTUQO01vYDOEZE/Vrr43EAYwA2ALjMzDeiAMaYK0R0NWgnMzfEARQBLBKRNs/znkQBMplMu1LqEYAfzLw8DuALgLUAOpn5ehTAGNNJRNcAfGXmdXEAlRncYebzUQBr7d3ACwB6mbkjEvCP5N8i0ux53ocaW7SLiF4CWAKgnZmnNmpmzDJaNpsdKhtrX9kD35xzJ9Pp9OsqPthfdnkfgFXlLRpm5orxogG5XK7JOTcIYCkAR0Q3nXPBszBORGuIqElELgFQYbVJ3/cPdHV1fY6lIEgyxmwnomA71teYwysAGwEE6/ldKdWSSqU+RraoklAoFBKjo6NnlVKtIrIDwBYAPoBA3T2t9e18Pr+5VCoNhk/GTxE56HleoPZvzPt/kMvltjnnXgBYBuBXefCHtdZvK4R5A8KWBhv1LIRMaK0biUim3qmoXY97bq3dCyBw/wgzH1pQBbU+YsEUzAWpO+APfeLiGcjy+NMAAAAASUVORK5CYII=") !important;
		background-position: 6px 6px !important;
		background-repeat: no-repeat !important;
		padding: .5rem 20px .5rem 2rem !important;
	}

	& .inner-sidebar-folder-child-nodes {
		margin-left: 0.5rem;
		border-left: 2px solid hsl(var(--border));
	}
}

.inner-sidebar-users {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
}
</style>