---
import { StudioCMSRoutes } from 'studiocms:lib';
import studioCMS_SDK from 'studiocms:sdk';
import { Button, Divider, Dropdown, Icon, Input } from 'studiocms:ui/components';
import UserListItem from './UserListItem.astro';

const Users = await studioCMS_SDK.GET.database.users();

const safeUsers: {
	id: string;
	name: string;
	email: string | null;
	avatar: string | null;
	username: string;
	permissionsData:
		| {
				user: string;
				rank: string;
		  }
		| undefined;
}[] = Users.map(({ avatar, email, id, name, username, permissionsData }) => {
	return { avatar, email, id, name, username, permissionsData };
});
---
<div class="inner-user-sidebar-header">
    <form id="search-form">
      <Input name='search' placeholder='Search...' type='search' required />
    </form>
    <Dropdown
      transition:persist
      transition:persist-props
      id='create-user-dropdown'
      options={[
        { label: 'Create New User', value: 'new-user', icon: 'user-plus' },
        { label: 'Create User Invite', value: 'new-invite', icon: 'inbox-arrow-down' },
      ]}
      align={'end'}
      offset={8}
      >
      <Button variant="solid" color="primary" size='sm' class="add-button">
      <Icon name="plus" width={24} height={24} />
      </Button>
    </Dropdown>
</div>

<Divider background={'background-step-1'}></Divider>

<div id="user-list"
    class="inner-sidebar-users scrollbar" 
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
    { Users.map((user) => <UserListItem user={user} />) }
</div>

<div id="search-list"
    class="inner-sidebar-users scrollbar" 
    style="display: none;"
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
</div>

<script>
    import { DropdownHelper } from 'studiocms:ui/components';
  
    function setupDropdown() {
        const createNewDropdown = new DropdownHelper('create-user-dropdown');
    
        createNewDropdown.registerClickCallback((value) => {
            console.log('Clicked', value);
        });
    };
  
    document.addEventListener('astro:page-load', setupDropdown);
    setupDropdown();
</script>

<script>
    import DOMPurify from "dompurify";
    import Fuse from "fuse.js";

    type User = {
            id: string;
            name: string;
            email: string | null;
            avatar: string | null;
            username: string;
            permissionsData:
                | {
                        user: string;
                        rank: string;
                }
                | undefined;
        };

    type Users = User[];

    function clearSearchParams(userListElm: HTMLDivElement, ActualList: HTMLDivElement) {
        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        window.history.pushState({}, '', url);
        userListElm.style.display = 'none';
        ActualList.style.display = 'flex';
    }

    async function runSearch(form: HTMLFormElement, userListElm: HTMLDivElement, users: Users, userListItemsPartial: string, ActualList: HTMLDivElement) {
        const formData = new FormData(form);
        
        const searchTerm = DOMPurify.sanitize(formData.get('search')?.toString() || '');

        if (!searchTerm || searchTerm.length === 0) return;

        const url = new URL(window.location.href);
        url.searchParams.set('search', searchTerm);
        window.history.pushState({}, '', url);

        const searchList = users;

        const fuse = new Fuse(searchList, {
            keys: ['name', 'username'],
            isCaseSensitive: false,
            threshold: 0.5,
        });

        const results = fuse.search(searchTerm);

        const res = await fetch(userListItemsPartial, {
            method: 'POST',
            body: JSON.stringify({ users: results.map((item) => item.item), searchQuery: searchTerm }),
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!res.ok) {
            console.error('Failed to fetch search list');
            return [];
        }

        const html = await res.text();

        userListElm.innerHTML = html;
        userListElm.style.display = 'flex';
        ActualList.style.display = 'none';
    }

    async function searchSetup() {
        const searchForm = document.getElementById('search-form') as HTMLFormElement;
        const searchInput = searchForm.querySelector('input[name="search"]') as HTMLInputElement;

        const ActualUserList = document.querySelector('#user-list') as HTMLDivElement;
        
        const userListElm = document.querySelector('#search-list') as HTMLDivElement;
        const users: Users = JSON.parse(userListElm.dataset.users!);
        const userListItemsPartial = userListElm.dataset.userpartial!;

        const url = new URL(window.location.href);

        const searchTerm = url.searchParams.get('search');

        if (searchTerm) {
            const input = searchInput;
            input.value = searchTerm;
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        });

        let timeout: NodeJS.Timeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(async () => await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList), 500);
        });

        searchInput.addEventListener('search', () => {
            clearSearchParams(userListElm, ActualUserList);
        });
    }

document.addEventListener('astro:page-load', searchSetup);
</script>