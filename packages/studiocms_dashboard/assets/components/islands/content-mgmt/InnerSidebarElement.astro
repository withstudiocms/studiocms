---
import { StudioCMSRoutes } from 'studiocms:lib';
import { studioCMS_SDK_Cache } from 'studiocms:sdk/cache';
import { Button, Divider, Dropdown, Icon, Input } from 'studiocms:ui/components';
import PageList from './PageList.astro';

interface Props {
	isNewFolder?: boolean;
	isNewPage?: boolean;
}

const { data: folderList } = await studioCMS_SDK_Cache.GET.folderList();
const pageList = await studioCMS_SDK_Cache.GET.pages();

const { isNewFolder, isNewPage } = Astro.props;
---

<div class="inner-sidebar-header">
  <form id="search-form">
    {/* 
    // @ts-ignore */}
    <Input name='search' placeholder='Search...' type='search' required />
  </form>
  <Dropdown
    transition:persist
    transition:persist-props
    id='create-new-dropdown'
    options={[
      { 
        label: 'Create Page', 
        icon: 'document-plus', 
        value: StudioCMSRoutes.mainLinks.contentManagementCreate 
      },
      { 
        label: 'Create Folder', 
        icon: 'folder-plus', 
        value: StudioCMSRoutes.mainLinks.contentManagementFolderCreate 
      },
    ]}
    align={'end'}
    offset={8}
    >
    <Button variant="solid" color="primary" size='sm' class="add-button">
    <Icon name="plus" width={24} height={24} />
    </Button>
  </Dropdown>
</div>

<Divider background={'background-step-2'}><span id="sidebar-divider-title">Items</span></Divider>

<div 
  class="inner-sidebar-items" 
  id="inner-sidebar-items" 
  >
  <PageList {isNewFolder} {isNewPage} />
</div>

<div
  class="inner-sidebar-items"
  id="inner-sidebar-items-search"
  style="display: none;"
  data-folders={JSON.stringify(folderList)} 
  data-pages={JSON.stringify(pageList)}
  data-editpage={StudioCMSRoutes.mainLinks.contentManagementEdit}
  data-editfolder={StudioCMSRoutes.mainLinks.contentManagementFolderEdit}
  transition:persist
  transition:persist-props
  ></div>

<script>
  import { DropdownHelper } from 'studiocms:ui/components';

function setupDropdown() {
    const createNewDropdown = new DropdownHelper('create-new-dropdown');

    createNewDropdown.registerClickCallback((value) => {
      window.location.href = value;
    });
  };

document.addEventListener('astro:page-load', setupDropdown);
setupDropdown();
</script>

<script>
  import DOMPurify from 'dompurify';
  import Fuse from 'fuse.js';

  type Folders = {
    id: string;
    name: string;
    parent?: string | null;
  }[];

  type Pages = {
    data: {
      id: string;
      title: string;
      slug: string;
      parentFolder: string | null;
    };
    lastCacheUpdate: Date;
  }[];
    
  type SearchItem = {
    id: string;
    name: string;
    slug?: string;
    type: 'folder' | 'page';
  };

  type SearchList = SearchItem[];

  const itemTemplate = (item: SearchItem, searchTerm: string) => {
    const url = item.type === 'folder' 
      ? `${document.getElementById('inner-sidebar-items-search')?.dataset.editfolder}?folder=${item.id}&search=${searchTerm}`
      : `${document.getElementById('inner-sidebar-items-search')?.dataset.editpage}/?edit=${item.id}&search=${searchTerm}`;
    return `
  <a href=${url} class="inner-sidebar-link" data-astro-reload>
    ${
      item.type === 'folder' 
      ? `<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /> </svg> ` 
      : `<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /> </svg>`
    }
    <span class="sidebar-link-text">
      ${item.name}
    </span>
  </a>
  `;
  };

  function getSearchList() {
    const folders = JSON.parse(document.getElementById('inner-sidebar-items-search')?.dataset.folders || '[]') as Folders;
    const pages = JSON.parse(document.getElementById('inner-sidebar-items-search')?.dataset.pages || '[]') as Pages;

    const searchList: SearchList = []

    for (const { id, name } of folders) {
      searchList.push({ id, name, type: 'folder' });
    }

    for (const { data: { id, title: name, slug } } of pages) {
      searchList.push({ id, name, slug, type: 'page' });
    }
      
    return searchList;
  }

  function clearSearchParams(dividerTitle: HTMLSpanElement, innerSidebarItemsSearch: HTMLDivElement) {
    const url = new URL(window.location.href);
    url.searchParams.delete('search');
    window.history.pushState({}, '', url);
    innerSidebarItemsSearch.innerHTML = '';
    document.getElementById('inner-sidebar-items')!.style.display = 'block';
    innerSidebarItemsSearch.style.display = 'none';
    dividerTitle.innerText = 'Items';
  }

  function runSearch(form: HTMLFormElement, divider: HTMLSpanElement, searchItems: HTMLDivElement) {
    const formData = new FormData(form);

    const searchTerm = DOMPurify.sanitize(formData.get('search')?.toString() || '');

    if (!searchTerm || searchTerm.length === 0) return;

    const url = new URL(window.location.href);
    url.searchParams.set('search', searchTerm);
    window.history.pushState({}, '', url);

    const searchList = getSearchList();

    const fuse = new Fuse(searchList, {
      keys: ['name', 'slug'],
      includeScore: true,
      threshold: 0.5,
    });

    const results = fuse.search(searchTerm);

    console.log(`Search Results (${results.length}) `, results);

    searchItems.innerHTML = results.map(({ item }) => {
      return itemTemplate(item, searchTerm);
    }).join('');

    document.getElementById('inner-sidebar-items')!.style.display = 'none';
    searchItems.style.display = 'block';
    divider.innerText = `Search Results (${results.length})`;
  }

  // Main Functions

  // Event Listeners
  function searchSetup() {
  const form = document.getElementById('search-form') as HTMLFormElement;
  const searchInput = form.querySelector('input[name=search]') as HTMLInputElement;

  const innerSidebarItemsSearch = document.getElementById('inner-sidebar-items-search') as HTMLDivElement;
  const dividerTitle = document.getElementById('sidebar-divider-title') as HTMLSpanElement;

    const url = new URL(window.location.href);
    const searchTerm = url.searchParams.get('search');
    if (searchTerm) {
      const input = searchInput;
      input.value = searchTerm;
      runSearch(form, dividerTitle, innerSidebarItemsSearch);
    }

    // if the user submits the form, run the search
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      runSearch(form, dividerTitle, innerSidebarItemsSearch);
    });

    // if the user stops typing for 500ms, run the search
    let timeout: NodeJS.Timeout;
    form.addEventListener('input', () => {
      if (searchInput.value.length === 0) clearSearchParams(dividerTitle, innerSidebarItemsSearch);

      clearTimeout(timeout);
      timeout = setTimeout(() => runSearch(form, dividerTitle, innerSidebarItemsSearch), 500);
    });

    // if the user clears the search, clear the query params
    searchInput.addEventListener('search', () => clearSearchParams(dividerTitle, innerSidebarItemsSearch));
  }

  document.addEventListener('astro:page-load', searchSetup);
</script>

<style>
  .inner-sidebar-header {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
  
    & input {
      margin-right: 1rem;
      width: 95%;
    }
  }
  
  .add-button {
    width: 32px !important;
    height: 32px !important;
    padding: 0.25rem !important;
  }
  
  .inner-sidebar-items {
    display: flex;
    flex-direction: column;
    gap: .375rem;
    width: 100%;
    height: 100%;
  }
  
  input[name=search] {
    /* heroicons:magnifying-glass-16-solid */
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAndJREFUSEvFlUtoFEEQhv/qRVkvevARiM+DiOAjKooS0KCYg9EIigrGi3jzIBK8bNdsCIHt3mURET14EwQhugQRIxg8KMRHEIMGQUFyCCiBGFBE8LLsdLkTZsUkm52BZLGuXV3f/FX19xDqHFTn+vh/gO7u7sXJZPK0iFwAsAnASgBjRDTsnOsvFot9PT09LqoDVRVkMpnVSqkBAFtrFBgBcI6ZP9WCzAIYYxqI6B2AxvDiGxEZSCQS733f30lEbQD2hGcTzrnd6XR6fC7INICIUDabfQ6gBcAkgIvM/GDmZWvtKRG5RUQrAAwxc3MsgDGmlYieBslEdERrHbSpahhjjhLR4zC3Q2vdWy1xmgJr7X0AZwA8ZOYTUQO01vYDOEZE/Vrr43EAYwA2ALjMzDeiAMaYK0R0NWgnMzfEARQBLBKRNs/znkQBMplMu1LqEYAfzLw8DuALgLUAOpn5ehTAGNNJRNcAfGXmdXEAlRncYebzUQBr7d3ACwB6mbkjEvCP5N8i0ux53ocaW7SLiF4CWAKgnZmnNmpmzDJaNpsdKhtrX9kD35xzJ9Pp9OsqPthfdnkfgFXlLRpm5orxogG5XK7JOTcIYCkAR0Q3nXPBszBORGuIqElELgFQYbVJ3/cPdHV1fY6lIEgyxmwnomA71teYwysAGwEE6/ldKdWSSqU+RraoklAoFBKjo6NnlVKtIrIDwBYAPoBA3T2t9e18Pr+5VCoNhk/GTxE56HleoPZvzPt/kMvltjnnXgBYBuBXefCHtdZvK4R5A8KWBhv1LIRMaK0biUim3qmoXY97bq3dCyBw/wgzH1pQBbU+YsEUzAWpO+APfeLiGcjy+NMAAAAASUVORK5CYII=") !important;
    background-position: 6px 6px !important;
    background-repeat: no-repeat !important;
    padding: .5rem 20px .5rem 2rem !important;
  }

</style>