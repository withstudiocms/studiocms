---
import { dashboardConfig } from 'studiocms:config';
import { useTranslations } from 'studiocms:i18n';
import { StudioCMSRoutes } from 'studiocms:lib';
import { Button, Divider, Dropdown, Group, Icon } from 'studiocms:ui/components';
import StudioCMSLogo from '../components/StudioCMSLogo.astro';
import SidebarLink from './SidebarLink.astro';
import Admin from './islands/sidebar/Admin.astro';
import Editor from './islands/sidebar/Editor.astro';
import UserAccount from './islands/sidebar/UserAccount.astro';
import VersionCheck from './islands/sidebar/VersionCheck.astro';
import { getSidebarLinks } from './sidebarConfig';

const { versionCheck } = dashboardConfig;
const lang = 'en-us';
const t = useTranslations(lang, '@studiocms/dashboard:sidebar');
const sidebar = getSidebarLinks(lang);
---

<div class="sidebar-links-container">
    <div class="sidebar-header">
      <StudioCMSLogo class={'sidebar-logo'} />
      <div class="sidebar-header-text">
        <span class="sidebar-title">StudioCMS</span>
        <span class="sidebar-subtitle">
          <Group>
          { versionCheck && <VersionCheck /> }
          <Button size='sm' variant="outlined" color={'default'} id={'studiocms-theme-toggle'} transition:persist transition:persist-props>
            <div id="dark-content">
              <Icon name='moon-16-solid' width={16} height={16} slot="dark" />
            </div>
            <div id="light-content">
              <Icon name='sun-16-solid' width={16} height={16} slot="light" />
            </div>
            <div id="fallback-content">
              <Icon name='arrow-path-16-solid' width={16} height={16} slot="fallback" />
            </div>
          </Button>
        </Group>
        </span>
      </div>
    </div>
    <Divider background='background-step-1'>{t("category-1-header")}</Divider>
    <div class="sidebar-link-group">
      {
        sidebar.baseLinks.map(({ href, icon, title }) => (
          <SidebarLink {icon} {href}>{title}</SidebarLink>
        ))
      }
      <Editor />
    </div>
    <Admin />
    { /* 
      Fallback slot removed from <Admin /> component to prevent the sidebar
      from displaying the fallback content when the user is not an admin.
    */}
  </div>  
  <div>
    <Dropdown 
      id='sidebar-user-dropdown'
      options={[
        { label: t("user-dropdown:settings"), value: 'user-settings', icon: "user", href: StudioCMSRoutes.mainLinks.userProfile },
        { label: t("user-dropdown:view-site"), value: 'view-site', icon: "globe-alt", href: StudioCMSRoutes.mainLinks.baseSiteURL },
        { label: t("user-dropdown:logout"), value: 'log-out', icon: "arrow-left-start-on-rectangle", href: StudioCMSRoutes.authLinks.logoutURL, color: 'danger' },
      ]}
      offset={8}
      transition:persist transition:persist-props
    >
      <div class="user-dropdown-trigger-container">
        <UserAccount transition:persist transition:persist-props />
      </div>
    </Dropdown>
  </div>


<script>
    import { DropdownHelper } from "studiocms:ui/components";
    import { ThemeHelper } from '@studiocms/ui/utils/ThemeHelper.js';

    function setup() {
        new DropdownHelper('sidebar-user-dropdown', true);
        const themeToggle = document.getElementById('studiocms-theme-toggle');
        const themeHelper = new ThemeHelper();
    
        themeHelper.registerToggle(themeToggle);

        const mediaMatcher = window.matchMedia("(prefers-color-scheme: light)");

        mediaMatcher.addEventListener("change", (event) => {
            themeHelper.setTheme(event.matches ? "light" : "dark");
        });
    }
  
    document.addEventListener('astro:page-load', () => {
        setup();
    });
  </script>