---
import { authEnvCheck } from 'studiocms:auth/utils/authEnvCheck';
import { StudioCMSRoutes } from 'studiocms:helpers/routemap';
import { getLangFromUrl, staticPaths, useTranslatedPath, useTranslations } from 'studiocms:i18n';
import Config from 'virtual:studiocms/config';
import { Button, Input } from '@studiocms/ui/components';
import type { GetStaticPaths } from 'astro';
import StaticAuthCheck from '../components/StaticAuthCheck.astro';
import AuthLayout from '../layouts/AuthLayout.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang, '@studiocms/auth:login');
const tPath = useTranslatedPath(lang);

export const getStaticPaths = (() => {
	const paths = staticPaths();
	return paths;
}) satisfies GetStaticPaths;

const {
	dashboardConfig: {
		AuthConfig: {
			providers,
			providers: {
				usernameAndPassword,
				usernameAndPasswordConfig: { allowUserRegistration },
			},
		},
	},
} = Config;

const {
	authLinks: { loginAPI, signupURL },
} = StudioCMSRoutes;

const { SHOW_OAUTH } = await authEnvCheck(providers);

let paragraph: string;

if (usernameAndPassword && SHOW_OAUTH) {
	paragraph = t('sub-header-usernamepasswordoauth');
} else if (usernameAndPassword && !SHOW_OAUTH) {
	paragraph = t('sub-header-usernamepassword');
} else if (!usernameAndPassword && SHOW_OAUTH) {
	paragraph = t('sub-header-oauth');
} else {
	paragraph = t('sub-header-noprovider');
}
---
<AuthLayout title={t('title')} description={t('description')} lang={lang}>

    <div slot="header" class="form-header">
        <h1>{t('header')}</h1>
        <p>{paragraph}</p>
    </div>

    { usernameAndPassword && (
        <form class="form" id="login-form" method="post" action={loginAPI}>

            <Input label={t('username-label')} name="username" type="text" />
            <Input label={t('password-label')} name="password" type='password' />

            <Button as="button" type="submit" color='primary' size='md' variant='solid'><span>{t('login-button')}</span></Button>
        </form>
    )}

    { allowUserRegistration && (
        <p slot="footer">{t('allow-registration-noaccount')} <a href={tPath(signupURL)}>{t('allow-registration-register')}</a></p>
    )}

    <StaticAuthCheck server:defer />

</AuthLayout>

<script>
    import { formListener } from 'studiocms:auth/scripts/formListener';
    const loginForm = document.getElementById('login-form') as HTMLFormElement;

    loginForm.addEventListener('submit', (event) => formListener(event, loginForm, 'login'));
</script>