---
import { getUserData } from 'studiocms:auth/lib/user';
import { authEnvCheck } from 'studiocms:auth/utils/authEnvCheck';
import { StudioCMSRoutes } from 'studiocms:helpers/routemap';
import Config from 'virtual:studiocms/config';
import { Button, Input } from '@studiocms/ui/components';
import AuthLayout from '../layouts/AuthLayout.astro';

const {
	dashboardConfig: {
		AuthConfig: {
			providers,
			providers: {
				usernameAndPassword,
				usernameAndPasswordConfig: { allowUserRegistration },
			},
		},
	},
} = Config;

const {
	authLinks: { loginAPI, loginURL },
	mainLinks: { dashboardIndex },
} = StudioCMSRoutes;

const { SHOW_OAUTH } = await authEnvCheck(providers);

let paragraph: string;

if (usernameAndPassword && SHOW_OAUTH) {
	paragraph = 'Create an account or log in using one of the options below.';
} else if (usernameAndPassword && !SHOW_OAUTH) {
	paragraph = 'Create an account using the form below.';
} else if (!usernameAndPassword && SHOW_OAUTH) {
	paragraph = 'Log in using one of the options below.';
} else {
	paragraph = 'No Login provider configured. Please contact your administrator.';
}

const user = await getUserData(Astro);

if (user.isLoggedIn) {
	return Astro.redirect(dashboardIndex);
}
---
<AuthLayout title="Signup Page" description="Signup Page">
    
    <div slot="header" class="form-header">
        <h1>Sign up</h1>
        <p>{paragraph}</p>
    </div>

    { usernameAndPassword && (
        <form class="form" id="signup-form" method="post" action={loginAPI}>

            <Input label="Username" name="username" type="text" />
            <Input label="Email" name="email" type="email" />
            <Input label="Display Name" name="displayname" type="text" />
            <Input label="Password" name="password" type="password" />
            <Input label="Confirm Password" name="confirm-password" type="password" />

            <Button type="submit" as="button" type="submit" color='primary' variant='solid'>Create Account</Button>
        </form>
    )}

    { allowUserRegistration && (
        <p slot="footer">Already have an account? <a href={loginURL}>Sign in!</a></p>
    )}

</AuthLayout>

<script>
    import { formListener } from 'studiocms:auth/scripts/formListener';
    const signupForm = document.getElementById('signup-form') as HTMLFormElement;

    signupForm.addEventListener('submit', async (event) => formListener(event, signupForm, 'register'));
</script>