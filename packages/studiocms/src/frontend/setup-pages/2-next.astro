---
import { StudioCMSRoutes } from 'studiocms:lib';
import { Button } from 'studiocms:ui/components/button';
import { Card } from 'studiocms:ui/components/card';
import { Center } from 'studiocms:ui/components/center';
import { Input } from 'studiocms:ui/components/input';
import { TabItem, Tabs } from 'studiocms:ui/components/tabs';
import type { AvailableIcons } from 'studiocms:ui/icons';
import PageHeader from '../components/first-time-setup/PageHeader.astro';
import { providerData, showOAuth } from '../components/shared/oAuthButtonProviders.js';
import Layout from '../layouts/FirstTimeSetupLayout.astro';

// Define the current images for the providers
// This is a mapping of provider labels to their respective icons.
// If a provider does not have an icon, it will be logged to the console.
// This is used to ensure that the icons are available for the providers in the UI.
// If a provider is not found, it will be skipped in the UI rendering.
const providerIcons: Record<string, AvailableIcons> = {
	github: 'simpleicons:github',
	discord: 'simpleicons:discord',
	google: 'flatcoloricons:google',
	auth0: 'simpleicons:auth0',
	generic: 'heroicons:identification',
};

// Map the provider data to the current images
const Providers = providerData
	.map((provider) => {
		if (!provider.enabled) return undefined;
		let icon = providerIcons[provider.label.toLowerCase()];
		if (!icon) {
			console.warn(`No icon found for provider: ${provider.label}`);
			icon = providerIcons.generic;
		}

		return {
			label: provider.label,
			icon: icon,
			href: provider.href,
		};
	})
	.filter(Boolean) as {
	label: string;
	icon: AvailableIcons;
	href: string;
}[];
---
<Layout title="Welcome to StudioCMS">

    <PageHeader title="Welcome to StudioCMS" badge={{ label: 'Step 2' }} />

    <Card class='card' style="background-color: var(--background-step-1)" fullWidth>

        <div slot="header">
            <h2>Create an Administrator</h2>
        </div>

        <Tabs variant='starlight'>
            <TabItem label='Username and Password'>
                <form id="setup-step-two" action={StudioCMSRoutes.fts.step2}>
                    <div class="form-content">
                        
                        <Input 
                            label='Username' 
                            name='username' 
                            placeholder='john' 
                            isRequired 
                            />
                        
                        <Input 
                            label='Display Name' 
                            name='displayname' 
                            placeholder='John Doe' 
                            isRequired 
                            />
                        
                        <Input 
                            label='Email' 
                            name='email' 
                            placeholder='john@doe.com' 
                            isRequired 
                            />

                        <Input 
                            label='Password' 
                            name='password' 
                            placeholder='password' 
                            type="password" 
                            isRequired 
                            />

                        <Input 
                            label='Confirm Password' 
                            name='confirm-password' 
                            placeholder='password' 
                            type="password" 
                            isRequired 
                            />

                    </div>
                </form>
            </TabItem>

            {
                showOAuth && Providers.map(({ href, icon, label }) => {
                    return (
                        <TabItem label={label} icon={icon}>
                            <Center>
                                <Button 
                                    color="primary" 
                                    as="a" 
                                    href={href} 
                                    aria-label={`Connect to ${label}`}
                                    >Connect to {label}
                                </Button>
                            </Center>
                        </TabItem>
                    )
                })
            }

        </Tabs>

        <div slot="footer">
            <div class="card-actions">
                <Button type="submit" form="setup-step-two" color="primary">Continue</Button> 
            </div>
        </div>

    </Card>

    <script>
        import { toast } from 'studiocms:ui/components/toaster';

        const form = document.querySelector('#setup-step-two') as HTMLFormElement;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);

            const data = {
                username: formData.get('username') as string,
                displayname: formData.get('displayname') as string,
                email: formData.get('email') as string,
                password: formData.get('password') as string,
                confirmPassword: formData.get('confirm-password') as string,
            }

            if (data.password !== data.confirmPassword) {
                toast({
                    title: 'Passwords do not match',
                    description: 'Please make sure the passwords match',
                    type: 'danger'
                });
                return;
            }

            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                window.location.assign('/done');
            } else {
                const error = await response.json();
                toast({
                    title: 'Error',
                    description: error.error,
                    type: 'danger',
                });
            }
        });
    </script>

    <style>
        .form-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
    
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
    
        .login-preview-container {
            width: min-content;
            height: min-content;
        }
    
        @media screen and (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .card {
            margin-left: 20%;
            margin-right: 20%;
            width: 60%;
        }

        @media screen and (max-width: 768px) {
            .card {
                margin-left: 0;
                margin-right: 0;
                width: 100%;
            }
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
    </style>

</Layout>