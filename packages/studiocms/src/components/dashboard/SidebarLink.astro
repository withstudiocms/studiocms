---
import { Icon } from 'studiocms:ui/components';
import type { HeroIconName } from '@studiocms/ui/components/Icon/iconType.js';
import type { HTMLAttributes } from 'astro/types';

interface Props extends HTMLAttributes<'a'> {
	/**
	 * ONLY USE OUTLINED ICONS! Shit will break otherwise
	 */
	icon: HeroIconName;
	href: string;
}

const { icon, ...props } = Astro.props;

const activeIcon = `${icon}-solid`;

const compId = crypto.randomUUID();
---
<sidebar-link id={compId} class="sidebar-link" data-dashboard-index={Astro.locals.StudioCMS.routeMap.mainLinks.dashboardIndex} {...props}>
  <Icon name={icon} id="not-selected-icon" class='sidebar-link-icon not-selected' width={24} height={24} />
  <Icon name={activeIcon as HeroIconName} id="selected-icon" class="sidebar-link-icon selected" width={24} height={24} />
  <span class="sidebar-link-text">
    <slot />
  </span>
</sidebar-link>

<script>
  class SidebarLink extends HTMLElement {
    href: string;
    dashboardIndex: string;

    constructor() {
      super();
      this.href = this.getAttribute("href") || "#";
      this.dashboardIndex = this.getAttribute("data-dashboard-index") || "";
    }

    connectedCallback() {
      this.render();
      this.setSidebarActiveState();
      this.setupEventListeners();
    }

    private render() {
      if (!this.shadowRoot) return;

      const slot = document.createElement("slot");
      slot.innerHTML = this.innerHTML;
      this.shadowRoot.appendChild(slot);
    }

    private setupEventListeners() {
      this.addEventListener('click', (event) => {
        event.preventDefault();
        const url = new URL(this.href, window.location.origin);
        window.location.href = url.href;
      });
    }

    private setSidebarActiveState() {
      const elm = document.getElementById(this.id);

      const notSelectedIcons = [
        this.shadowRoot?.getElementById('not-selected-icon'),
        elm?.querySelector<HTMLElement>('#not-selected-icon')
      ];
      const selectedIcons = [
        this.shadowRoot?.getElementById('selected-icon'),
        elm?.querySelector<HTMLElement>('#selected-icon')
      ];

      const windowLocation = window.location.pathname;
      const elemPath = new URL(this.href, window.location.origin).pathname;

      const webDashboardIndex = new URL(window.location.origin + this.dashboardIndex).pathname;

      if (elemPath === windowLocation) {
        notSelectedIcons.forEach(icon => {
          if (icon) icon.style.display = 'none';
        });
        selectedIcons.forEach(icon => {
          if (icon) icon.style.display = 'block';
        });
        this.classList.add('active');
      }

      if (windowLocation.includes(elemPath) && elemPath !== webDashboardIndex) {
        notSelectedIcons.forEach(icon => {
          if (icon) icon.style.display = 'none';
        });
        selectedIcons.forEach(icon => {
          if (icon) icon.style.display = 'block';
        });
        this.classList.add('active');
      }
    }

  }

  if (!customElements.get('sidebar-link')) {
    customElements.define('sidebar-link', SidebarLink);
  }
</script>
