---
import { StudioCMSRoutes } from 'studiocms:lib';
import studioCMS_SDK from 'studiocms:sdk';
import {
	Button,
	Center,
	Divider,
	Dropdown,
	Icon,
	Input,
	Modal,
	Select,
} from 'studiocms:ui/components';
import UserListItem from './UserListItem.astro';

const Users = await studioCMS_SDK.GET.database.users();

const safeUsers: {
	id: string;
	name: string;
	email: string | null;
	avatar: string | null;
	username: string;
	permissionsData:
		| {
				user: string;
				rank: string;
		  }
		| undefined;
}[] = Users.map(({ avatar, email, id, name, username, permissionsData }) => {
	return { avatar, email, id, name, username, permissionsData };
});
---
<div class="inner-user-sidebar-header">
    <form id="search-form">
      <Input name='search' placeholder='Search...' type='search' required />
    </form>
    <Dropdown
      transition:persist
      transition:persist-props
      id='create-user-dropdown'
      options={[
        { label: 'Create New User', icon: 'user-plus', value: 'new-user' },
        { label: 'Create User Invite', icon: 'inbox-arrow-down', value: 'new-invite' },
      ]}
      align={'end'}
      offset={8}
      >
      <Button variant="solid" color="primary" size='sm' class="add-button">
      <Icon name="plus" width={24} height={24} />
      </Button>
    </Dropdown>
</div>
<Modal
  id='create-new-user-modal'
  cancelButton={{ label: 'Cancel', color: 'default' }}
  actionButton={{ label: 'Confirm', color: 'danger' }}
  isForm
>
  <h2 slot='header'>Create New User</h2>
  <div class="modal-body">
    <Input label="Username" name="username" type="text" isRequired />
    <Input label="Email Address" name="email" type="email" isRequired />
    <Input label="Display Name" name="display_name" type="text" isRequired />
    <Input label="Password" name="password" type="password" />
    <Select fullWidth name='rank' label='User Rank' defaultValue='visitor' options={[
        { label: 'Visitor', value: 'visitor' },
        { label: 'Editor', value: 'editor' },
        { label: 'Administrator', value: 'admin' },
        { label: 'Owner', value: 'owner' },
    ]} />
  </div>
</Modal>

<Modal
  id='create-user-invite-modal'
  cancelButton={{ label: 'Cancel', color: 'default' }}
  actionButton={{ label: 'Confirm', color: 'danger' }}
  isForm
>
  <h2 slot='header'>Create User Invite</h2>
  <div class="modal-body">
    <Input label="Username" name="username" type="text" isRequired />
    <Input label="Email Address" name="email" type="email" isRequired />
    <Input label="Display Name" name="display_name" type="text" isRequired />
    <Select fullWidth name='rank' label='User Rank' defaultValue='visitor' options={[
        { label: 'Visitor', value: 'visitor' },
        { label: 'Editor', value: 'editor' },
        { label: 'Administrator', value: 'admin' },
        { label: 'Owner', value: 'owner' },
    ]} />
  </div>
</Modal>

<Modal id='create-response-modal'>
  <h2 slot="header">New User Information</h2>
  <Center>
    <div class="modal-body">
        <span>This will only be shown once, please save this information.</span>
      <code id="create-response-placeholder"></code>
    </div>
  </Center>
</Modal>

<Modal id='invite-response-modal'>
  <h2 slot="header"></h2>
  <Center>
    <div class="modal-body">
      <span>This will only be shown once, please save this information.</span>
      <br />
      <span>Invite Link: </span>
      <code id="invite-response-placeholder"></code>
    </div>
  </Center>
</Modal>

<Divider background={'background-step-1'}></Divider>

<div id="user-list"
    class="inner-sidebar-users scrollbar" 
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
    { Users.map((user) => <UserListItem user={user} />) }
</div>

<div id="search-list"
    class="inner-sidebar-users scrollbar" 
    style="display: none;"
    data-userpartial={StudioCMSRoutes.endpointLinks.partials.userListItems}
    data-users={JSON.stringify(safeUsers)}
    >
</div>

<div id="new-users-links"
  style="display: none;"
  data-create_user={StudioCMSRoutes.endpointLinks.newUsers.create}
  data-create_invite={StudioCMSRoutes.endpointLinks.newUsers.invite}
  ></div>

<script>
    import { DropdownHelper, ModalHelper, toast } from 'studiocms:ui/components';
  
    const createNewDropdown = new DropdownHelper('create-user-dropdown');
    const createNewUserModal = new ModalHelper('create-new-user-modal');
    const createUserInviteModal = new ModalHelper('create-user-invite-modal');

    const createResponseModal = new ModalHelper('create-response-modal');
    const inviteResponseModal = new ModalHelper('invite-response-modal');

    const createResponsePlaceholder = document.getElementById('create-response-placeholder') as HTMLElement;
    const inviteResponsePlaceholder = document.getElementById('invite-response-placeholder') as HTMLElement;

    const newUsersLinks = document.getElementById('new-users-links') as HTMLDivElement;

    const createNewUserLink = newUsersLinks.dataset.create_user as string;
    const createUserInviteLink = newUsersLinks.dataset.create_invite as string;
    
    createNewDropdown.registerClickCallback((value) => {
        if (value === 'new-user') {
            createNewUserModal.show();
        } else if (value === 'new-invite') {
            createUserInviteModal.show();
        }
    });

    createNewUserModal.registerConfirmCallback(async (formData) => {
        const username = formData?.get('username');
        const email = formData?.get('email');
        const password = formData?.get('password');
        const displayname = formData?.get('display_name');
        const rank = formData?.get('rank');

        const data = {
            username,
            email,
            password,
            displayname, 
            rank
        };

        const apiResponse = await fetch(createNewUserLink, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });

        const response = await apiResponse.json();

        if (!apiResponse.ok) {
            console.error('Failed to create new user');
            toast({
                title: 'Failed to create new user',
                description: response.error,
                type: 'danger',
            })
            return;
        }

        createResponsePlaceholder.innerText = JSON.stringify(response, null, 2);

        createNewUserModal.hide();
        createResponseModal.show();
    });

    createUserInviteModal.registerConfirmCallback(async (formData) => {
        const username = formData?.get('username');
        const email = formData?.get('email');
        const displayname = formData?.get('display_name');
        const rank = formData?.get('rank');

        const data = {
            username,
            email,
            displayname, 
            rank,
            originalUrl: window.location.origin
        };

        const apiResponse = await fetch(createUserInviteLink, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });

        const response = await apiResponse.json();

        if (!apiResponse.ok) {
            console.error('Failed to create new user invite');
            toast({
                title: 'Failed to create new user invite',
                description: response.error,
                type: 'danger',
            })
            return;
        }

        inviteResponsePlaceholder.innerText = response.link;

        createUserInviteModal.hide();
        inviteResponseModal.show();
    });
</script>

<script>
    import DOMPurify from "dompurify";
    import Fuse from "fuse.js";

    type User = {
            id: string;
            name: string;
            email: string | null;
            avatar: string | null;
            username: string;
            permissionsData:
                | {
                        user: string;
                        rank: string;
                }
                | undefined;
        };

    type Users = User[];

    function clearSearchParams(userListElm: HTMLDivElement, ActualList: HTMLDivElement) {
        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        window.history.pushState({}, '', url);
        userListElm.style.display = 'none';
        ActualList.style.display = 'flex';
    }

    async function runSearch(form: HTMLFormElement, userListElm: HTMLDivElement, users: Users, userListItemsPartial: string, ActualList: HTMLDivElement) {
        const formData = new FormData(form);
        
        const searchTerm = DOMPurify.sanitize(formData.get('search')?.toString() || '');

        if (!searchTerm || searchTerm.length === 0) return;

        const url = new URL(window.location.href);
        url.searchParams.set('search', searchTerm);
        window.history.pushState({}, '', url);

        const searchList = users;

        const fuse = new Fuse(searchList, {
            keys: ['name', 'username'],
            isCaseSensitive: false,
            threshold: 0.5,
        });

        const results = fuse.search(searchTerm);

        const res = await fetch(userListItemsPartial, {
            method: 'POST',
            body: JSON.stringify({ users: results.map((item) => item.item), searchQuery: searchTerm }),
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!res.ok) {
            console.error('Failed to fetch search list');
            return [];
        }

        const html = await res.text();

        userListElm.innerHTML = html;
        userListElm.style.display = 'flex';
        ActualList.style.display = 'none';
    }

    async function searchSetup() {
        const searchForm = document.getElementById('search-form') as HTMLFormElement;
        const searchInput = searchForm.querySelector('input[name="search"]') as HTMLInputElement;

        const ActualUserList = document.querySelector('#user-list') as HTMLDivElement;
        
        const userListElm = document.querySelector('#search-list') as HTMLDivElement;
        const users: Users = JSON.parse(userListElm.dataset.users!);
        const userListItemsPartial = userListElm.dataset.userpartial!;

        const url = new URL(window.location.href);

        const searchTerm = url.searchParams.get('search');

        if (searchTerm) {
            const input = searchInput;
            input.value = searchTerm;
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList);
        });

        let timeout: NodeJS.Timeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(async () => await runSearch(searchForm, userListElm, users, userListItemsPartial, ActualUserList), 500);
        });

        searchInput.addEventListener('search', () => {
            clearSearchParams(userListElm, ActualUserList);
        });
    }

searchSetup();
</script>

<style>
  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;

    span {
        font-size: .875rem;
    }

    code {
        background-color: hsl(var(--background-step-3));
        padding: .25rem;
        border-radius: 4px;
    }
  }
</style>