---
import dashboardGridItems from 'studiocms:components/dashboard-grid-items';
import { validImages } from 'studiocms:auth/utils/validImages';
import { StudioCMSRoutes } from 'studiocms:lib';
import studioCMS_SDK_Cache from 'studiocms:sdk/cache';
import { Card, Divider, Input, Select, Toggle } from 'studiocms:ui/components';
import LightVsDark from './LightVsDark.astro';

const { data } = await studioCMS_SDK_Cache.GET.siteConfig();

const ogSelectOptions = validImages.map(({ label, name: value }) => ({ label, value }));

const currentLoginPageBg = validImages.find(
	({ name }) => name === data.loginPageBackground && name !== 'custom'
);

const blobs = validImages.filter(({ name }) => name === 'studiocms-blobs')[0];
const blocks = validImages.filter(({ name }) => name === 'studiocms-blocks')[0];
const curves = validImages.filter(({ name }) => name === 'studiocms-curves')[0];

const currentlyEnabledGridItems: string[] = data.gridItems as string[] ?? [];

const allGridItems: string[] = dashboardGridItems.map((item) => item.name);

type AllGridItems = {
    enabled: boolean;
    name: string;
}[];

const gridItemOptions: AllGridItems = allGridItems.map((name) => {
    if (currentlyEnabledGridItems.length === 0) {
        return {
            enabled: true,
            name,
        }
    }

    return {
        enabled: currentlyEnabledGridItems.includes(name),
        name,
    }
})
---

<form id="site-config-form" action={StudioCMSRoutes.endpointLinks.config}>
    <div class="form-content">

        <div class="form-row">
            <Input label='Site Title' name='site-title' placeholder='My Awesome Website' value={data.title} isRequired />
            <Input label='Site Description' name='site-description' placeholder='Built with StudioCMS!' value={data.description} isRequired />
        </div>

        <div class="form-row">
            <Input label="Default Open Graph Image" name="default-og-image" placeholder="'https://...' for local, or '/...' for public/ folder" value={data.defaultOgImage} />
            <Input label="Site Icon (Public facing Favicon)" name="site-icon" placeholder="'https://...' for local, or '/...' for public/ folder" value={data.siteIcon} />
        </div>

        <div class="form-row">
            <Select label="Page Diff Tracking" name="diff-enabled" defaultValue={`${data.enableDiffs}`} options={[{ label: 'Enabled', value: 'true' }, { label: 'Disabled', value: 'false' }]} fullWidth />
            <Input label="Page Diff Tracking Limit (per page)" name="diff-per-page" placeholder="10" value={data.diffPerPage} />
        </div>

        <Divider />

        <span>Dashboard Grid Items</span>

        <div class="grid-items-container">
            {
                gridItemOptions.map((item) => (
                    <Card><Toggle label={item.name} name={item.name} color='primary' defaultChecked={item.enabled} /></Card>
                ))
            }
        </div>

        <Divider />

        <div class="form-row">
            <Select label='Login Page Background Image' name='login-page-background' defaultValue={data.loginPageBackground} options={ogSelectOptions} fullWidth />
            <Input label="Login Page Background Image (Custom)" name="login-page-background-custom" placeholder="'https://...' for local, or '/...' for public/ folder" value={data.loginPageCustomImage} disabled={data.loginPageBackground !== 'custom'} />
        </div>

        <Card class="login-preview-container">
            <div slot="header">
                <span>Login Page Preview (Dark/Light)</span>
            </div>
            {
                currentLoginPageBg && currentLoginPageBg.name !== 'custom' && (
                    <LightVsDark light={currentLoginPageBg.light!} dark={currentLoginPageBg.dark!} />
                )
            }
        </Card>

    </div>
</form>

<div id="login-page-bgs"
    data-blobs-light={blobs?.light?.src} data-blobs-dark={blobs?.dark?.src}
    data-blocks-light={blocks?.light?.src} data-blocks-dark={blocks?.dark?.src}
    data-curves-light={curves?.light?.src} data-curves-dark={curves?.dark?.src}
></div>

<script>
    import { toast } from "studiocms:ui/components";
        const configForm = document.querySelector('#site-config-form') as HTMLFormElement;

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(configForm);

            // Get dashboard grid items
            const gridItems = Array.from(configForm.querySelectorAll('input[type="checkbox"]') as NodeListOf<HTMLInputElement>).map((input) => {
                return {
                    name: input.name,
                    enabled: input.checked,
                }
            });

            const enabledGridItems = gridItems.filter((item) => item.enabled).map((item) => item.name);

            const data = {
                title: formData.get('site-title') as string,
                description: formData.get('site-description') as string,
                defaultOgImage: formData.get('default-og-image') ?? null,
                siteIcon: formData.get('site-icon') ?? null,
                loginPageBackground: formData.get('login-page-background') as string,
                loginPageCustomImage: formData.get('login-page-background-custom') ?? null,
                enableDiffs: formData.get('diff-enabled') === 'true',
                diffPerPage: parseInt(formData.get('diff-per-page') as string),
                gridItems: enabledGridItems,
            }

            console.log(data);

            const response = await fetch(configForm.action, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            const res = await response.json();

            if (response.status !== 200) {
                toast({
                    title: 'Error',
                    description: res.error,
                    type: 'danger'
                })
            }

            if (response.status === 200) {
                toast({
                    title: 'Success',
                    description: res.message,
                    type: 'success'
                })
            }
        });
</script>

<script is:inline>
async function setupLoginPreview() {
    // Selectors
    const loginPageBgSelectOptions = document.querySelector('#login-page-background-dropdown').querySelectorAll('.sui-select-option');
    const customInput = document.querySelector('input[name="login-page-background-custom"]');
    const customInputLabel = document.querySelector('label[for="login-page-background-custom"]');
    const previewContainer = document.querySelector('.login-preview-container');
    const lightImageHolder = document.querySelector('.light-image-holder');
    const darkImageHolder = document.querySelector('.dark-image-holder');

    // Backgrounds
    const loginPageBgs = document.querySelector('#login-page-bgs');

    const blobs = {
        light: loginPageBgs.getAttribute('data-blobs-light'),
        dark: loginPageBgs.getAttribute('data-blobs-dark'),
    }

    const blocks = {
        light: loginPageBgs.getAttribute('data-blocks-light'),
        dark: loginPageBgs.getAttribute('data-blocks-dark'),
    }

    const curves = {
        light: loginPageBgs.getAttribute('data-curves-light'),
        dark: loginPageBgs.getAttribute('data-curves-dark'),
    }

    // Event Listeners
    loginPageBgSelectOptions.forEach((option) => {
        option.addEventListener('click', () => {
            const selectedValue = option.getAttribute('value');

            if (selectedValue === 'custom') {
                customInput.removeAttribute('disabled');
                customInputLabel.classList.remove('disabled');
            } else {
                customInput.setAttribute('disabled', 'disabled');
                customInputLabel.classList.add('disabled');
            }

            if (selectedValue === 'custom') {
                previewContainer.style.display = 'none';
            } else {
                previewContainer.style.display = 'block';

                if (selectedValue === 'studiocms-blobs') {
                    lightImageHolder.src = blobs.light;
                    darkImageHolder.src = blobs.dark;
                }

                if (selectedValue === 'studiocms-blocks') {
                    lightImageHolder.src = blocks.light;
                    darkImageHolder.src = blocks.dark;
                }

                if (selectedValue === 'studiocms-curves') {
                    lightImageHolder.src = curves.light;
                    darkImageHolder.src = curves.dark;
                }

            }
        });
    });
}

document.addEventListener('astro:page-load', setupLoginPreview);
setupLoginPreview();
</script>

<style>
    .form-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .login-preview-container {
        width: min-content;
        height: min-content;
    }

    @media screen and (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .grid-items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
</style>