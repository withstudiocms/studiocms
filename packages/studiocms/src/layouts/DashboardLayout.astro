---
import type { UserSessionData } from 'studiocms:auth/lib/types';
import type { SiteConfigCacheObject } from 'studiocms:sdk/types';
import { Toaster } from 'studiocms:ui/components/toaster';
import type { AvailablePermissionRanks } from '@withstudiocms/auth-kit/types';
import BaseHead from '../components/dashboard/BaseHead.astro';
import DoubleSidebar from '../components/dashboard/DoubleSidebar.astro';
import LoginChecker from '../components/dashboard/LoginChecker.astro';
import SidebarModals from '../components/dashboard/SidebarModals.astro';
import SingleSidebar from '../components/dashboard/SingleSidebar.astro';

const makePageTitle = (
	pageName: string,
	config: {
		title: string;
	},
	separator?: string
) => {
	const separatorString = separator ? `${separator}` : '|';

	return `${pageName} ${separatorString} ${config.title}`;
};

const latestVersion = Astro.locals.StudioCMS.latestVersion;

type Props = {
	config: SiteConfigCacheObject;
	title: string;
	description?: string;
	lang?: string;
	sidebar?: false | 'single' | 'double';
	requiredPermission?: AvailablePermissionRanks | 'none';
	currentUser: UserSessionData | null;
};

const {
	config,
	title: propTitle,
	description: propDescription,
	lang = 'en',
	requiredPermission = 'unknown',
	sidebar = 'single',
	currentUser,
} = Astro.props;

const title = makePageTitle(propTitle, config.data);
const description = propDescription ?? config.data.description;
---

<!DOCTYPE html>
<html {lang}>
  <BaseHead {title} {description} />
  <body>
    <Toaster />
    { requiredPermission !== 'none' && ( 
      <LoginChecker {requiredPermission} {currentUser} />
     ) }
     <SidebarModals {latestVersion} />
    { sidebar === 'single' && <SingleSidebar {currentUser} {latestVersion} /> }
    { sidebar === 'double' && <DoubleSidebar {currentUser} {latestVersion} >
        <slot name="double-sidebar" />
      </DoubleSidebar> }

    <main>
      <div class="container">

        <div class="page-header">
          <slot name="header" />
        </div>

        <div class="container-content">
          <slot />
        </div>

      </div>
    </main>
    <style>
      .page-header {
        margin-bottom: 1.5rem;
      }
    </style>
  </body>
</html>
