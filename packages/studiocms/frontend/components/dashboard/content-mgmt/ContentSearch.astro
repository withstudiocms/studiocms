---
import { type UiLanguageKeys, useTranslations } from 'studiocms:i18n';
import { Input } from 'studiocms:ui/components/input';

interface Props {
	lang: UiLanguageKeys;
	treeRenderElId: string;
	searchOutputElId: string;
}

const { lang, treeRenderElId, searchOutputElId } = Astro.props;
const t = useTranslations(lang, '@studiocms/dashboard:content-sidebar');
---

<form
    id="search-form"
    data-tree-render-el-id={treeRenderElId}
    data-search-output-el-id={searchOutputElId}
>
    <Input
        name="search"
        placeholder={t("input-placeholder-search")}
        type="search"
        required
        icon="heroicons:magnifying-glass-16-solid"
    />
</form>

<script>
    import DOMPurify from "dompurify";
    import Fuse from "fuse.js";
    import {
        $i18n,
        baseTranslation,
        updateElmPlaceholder,
    } from "studiocms:i18n/client";

    const currentPage = "@studiocms/dashboard:content-sidebar";

    const i18n = $i18n(currentPage, baseTranslation[currentPage]);

    i18n.subscribe((comp) => {
        updateElmPlaceholder("search", comp["input-placeholder-search"]);
    });

    const $ = <E extends HTMLElement>(selector: string, context = document) =>
        context.querySelector(selector) as E;

    const form = $("#search-form") as HTMLFormElement;
    const treeRenderElId = form.dataset.treeRenderElId as string;
    const searchOutputElId = form.dataset.searchOutputElId as string;

    const treeRenderEl = document.getElementById(
        treeRenderElId,
    ) as HTMLDivElement;
    const searchOutputEl = document.getElementById(
        searchOutputElId,
    ) as HTMLDivElement;

    type SearchItem = {
        id: string;
        name: string;
        slug?: string;
        type: "folder" | "page";
        isDraft?: boolean;
    };

    type SearchList = SearchItem[];

    function getIcon(item: SearchItem) {
        if (item.type === "folder") {
            // heroicons:folder
            return `<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="leaf-icon default"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /> </svg> 
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="20" width="20" fill="currentColor" class="leaf-icon active"><path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" /></svg>`;
        }

        if (item.slug === "index") {
            // heroicons:home-modern
            return `<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="leaf-icon default"> <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m1.5.5-1.5-.5M6.75 7.364V3h-3v18m3-13.636 10.5-3.819" /> </svg> 
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="20" width="20"  fill="currentColor" class="leaf-icon active"> <path d="M19.006 3.705a.75.75 0 1 0-.512-1.41L6 6.838V3a.75.75 0 0 0-.75-.75h-1.5A.75.75 0 0 0 3 3v4.93l-1.006.365a.75.75 0 0 0 .512 1.41l16.5-6Z" /> <path fill-rule="evenodd" d="M3.019 11.114 18 5.667v3.421l4.006 1.457a.75.75 0 1 1-.512 1.41l-.494-.18v8.475h.75a.75.75 0 0 1 0 1.5H2.25a.75.75 0 0 1 0-1.5H3v-9.129l.019-.007ZM18 20.25v-9.566l1.5.546v9.02H18Zm-9-6a.75.75 0 0 0-.75.75v4.5c0 .414.336.75.75.75h3a.75.75 0 0 0 .75-.75V15a.75.75 0 0 0-.75-.75H9Z" clip-rule="evenodd" /> </svg>`;
        }

        if (item.isDraft) {
            // heroicons:pencil
            return `<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="leaf-icon default"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
            
            <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="currentColor" class="leaf-icon active"><path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z" /></svg>`;
        }

        // heroicons:document-text
        return `<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="leaf-icon default"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /> </svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="currentColor" class="leaf-icon active"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625ZM7.5 15a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 7.5 15Zm.75 2.25a.75.75 0 0 0 0 1.5H12a.75.75 0 0 0 0-1.5H8.25Z" clip-rule="evenodd" /><path d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z" /></svg>`;
    }

    async function getSearchList(searchItems: HTMLDivElement) {
        console.log(
            `Fetching search list from ${searchItems.dataset.searchlist}`,
        );

        const response = await fetch(searchItems.dataset.searchlist as string);

        if (!response.ok) {
            console.error("Failed to fetch search list");
            return [];
        }

        const data: SearchList = await response.json();

        return data;
    }

    function clearSearchParams(innerSidebarItemsSearch: HTMLDivElement) {
        const url = new URL(window.location.href);
        url.searchParams.delete("search");
        window.history.pushState({}, "", url);
        innerSidebarItemsSearch.innerHTML = "";
        treeRenderEl.style.display = "flex";
        innerSidebarItemsSearch.style.display = "none";
    }

    const itemTemplate = (item: SearchItem, searchTerm: string) => {
        const base = searchOutputEl;
        const safeSearch = encodeURIComponent(searchTerm);
        const safeId = encodeURIComponent(item.id);
        const url =
            item.type === "folder"
                ? `${base?.dataset.editfolder}?folder=${safeId}&search=${safeSearch}`
                : `${base?.dataset.editpage}/?edit=${safeId}&search=${safeSearch}`;
        const safeName = DOMPurify.sanitize(item.name, {
            ALLOWED_TAGS: [],
            ALLOWED_ATTR: [],
        });

        const nodeId = `search-node-${safeId}`;

        // inline mock of the FolderTreeLeaf component (script is available globally so this works)
        return `
        <folder-tree-leaf data-node-id="${nodeId}" data-page-id="${item.id}" data-depth="0" id="search-selector" data-href="${url}" class="tree-leaf" role="treeitem" tabindex="0">
            ${getIcon(item)}
            <span class="tree-leaf-label">${safeName}</span>
            ${item.isDraft ? `<span class="leaf-badge draft-badge"><t-file-tree-renderer key="badge-draft">Draft</t-file-tree-renderer></span>` : ""}
        </folder-tree-leaf>
        <div id="${nodeId}-context-menu" class="context-menu" role="menu">
            <button class="context-menu-item" role="menuitem" data-action="edit">
                <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="leaf-icon default"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
                <span>
                    <t-file-tree-renderer key="edit-page">Edit</t-file-tree-renderer>
                </span>
            </button>
        </div>
        `;
    };

    async function runSearch(
        form: HTMLFormElement,
        searchItems: HTMLDivElement,
    ) {
        const formData = new FormData(form);

        const query = formData.get("search") as string;

        const searchTerm = DOMPurify.sanitize(query.trim());

        if (!searchTerm || searchTerm.length < 2) {
            clearSearchParams(searchItems);
            return;
        }

        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("search", searchTerm);
        window.history.pushState({}, "", currentUrl);

        const searchList = await getSearchList(searchItems);

        const fuse = new Fuse(searchList, {
            keys: ["name", "slug"],
            threshold: 0.3,
            isCaseSensitive: false,
        });

        const results = fuse.search(searchTerm);

        const newHTML = DOMPurify.sanitize(
            results.map(({ item }) => itemTemplate(item, searchTerm)).join(""),
            {
                ALLOWED_TAGS: [
                    "div",
                    "span",
                    "svg",
                    "path",
                    "folder-tree-leaf",
                    "t-file-tree-renderer",
                    "button",
                ],
                ALLOWED_ATTR: [
                    "class",
                    "data-node-id",
                    "data-page-id",
                    "data-depth",
                    "data-href",
                    "role",
                    "tabindex",
                    "fill",
                    "viewBox",
                    "stroke-width",
                    "stroke",
                    "d",
                    "height",
                    "width",
                    "id",
                    "data-action",
                ],
            },
        );

        searchItems.innerHTML = newHTML;

        treeRenderEl.style.display = "none";
        searchItems.style.display = "flex";
    }

    async function searchInit() {
        const searchInput = form.querySelector(
            'input[name="search"]',
        ) as HTMLInputElement;

        const innerSidebarItemsSearch = searchOutputEl;

        const url = new URL(window.location.href);
        const searchParam = url.searchParams.get("search") || "";

        if (searchParam.length >= 2) {
            const input = searchInput;
            input.value = searchParam;
            await runSearch(form, innerSidebarItemsSearch);
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            await runSearch(form, innerSidebarItemsSearch);
        });

        let debounceTimeout: NodeJS.Timeout;
        searchInput.addEventListener("input", () => {
            if (searchInput.value.length < 2) {
                clearSearchParams(innerSidebarItemsSearch);
                return;
            }

            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(
                async () => await runSearch(form, innerSidebarItemsSearch),
                500,
            );
        });

        // if the user clears the search, clear the query params
        searchInput.addEventListener("search", () =>
            clearSearchParams(innerSidebarItemsSearch),
        );
    }

    searchInit();
</script>
