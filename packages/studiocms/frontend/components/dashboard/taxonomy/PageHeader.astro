---
import type { UiLanguageKeys } from 'studiocms:i18n';
import { useTranslations } from 'studiocms:i18n';
import { Button } from 'studiocms:ui/components/button';
import { Group } from 'studiocms:ui/components/group';
import { Icon } from 'studiocms:ui/components/icon';

interface Props {
	lang: UiLanguageKeys;
	type: 'index' | 'categories' | 'tags';
	mode?: 'edit' | 'create';
	pageTitle?: string;
}

const { lang, type, mode, pageTitle = '' } = Astro.props;

// Validation checks for required props
if (['categories', 'tags'].includes(type) && !mode) {
	throw new Error('Mode is required when type is categories or tags');
}

// Additional check for pageTitle when editing categories or tags
if (['categories', 'tags'].includes(type) && mode === 'edit' && !pageTitle) {
	throw new Error('pageTitle is required when type is categories or tags and mode is edit');
}

const t = useTranslations(lang, '@studiocms/dashboard:taxonomy-header');

const replaceNameParam = (str: string) => str.replace('{name}', pageTitle);
---
<tabs-context-updater {type}></tabs-context-updater>

<header class="page-header">
    <div class="page-title-container" id="page-header-data" data-page-title={pageTitle} data-title-translation-key={
        type === 'tags' && mode === 'edit' ? 'tags.edit-title' : type === 'categories' && mode === 'edit' ? 'categories.edit-title' : ''
    } data-type={type} data-mode={mode}>
        <Button color='primary' id='nav-open' class='mobile-btn'>
            <Icon name="heroicons:bars-3" height={24} width={24} slot="start-content" />
        </Button>
        <h1 id="page-title" class="page-title">
            {type === 'index' && (
                <t-taxonomy-header key="index.title">{t('index.title')}</t-taxonomy-header>
            )}
            {type === 'categories' && mode === 'create' && (
                <t-taxonomy-header key="categories.create-title">{t('categories.create-title')}</t-taxonomy-header>
            )}
            {type === 'tags' && mode === 'create' && (
                <t-taxonomy-header key="tags.create-title">{t('tags.create-title')}</t-taxonomy-header>
            )}
            {type === 'tags' && mode === 'edit' && replaceNameParam(t('tags.edit-title'))}
            {type === 'categories' && mode === 'edit' && replaceNameParam(t('categories.edit-title'))}
        </h1>
    </div>
    <div id="page-actions-container" class="page-actions-container">
        {

            mode === 'edit' && (
                <Group>
                    {/* TODO: Implement delete functionality */}
                    <Button 
                        form={
                            type === 'categories' 
                                ? 'category-form' 
                                : type === 'tags' 
                                    ? 'tag-form' 
                                    : ''
                        }
                        variant="outlined"
                        color="danger"
                        id="delete-taxonomy-entry-btn"
                        type={'button'}
                        disabled
                    >
                        <Icon
                            name="heroicons:trash"
                            width={20}
                            height={20}
                            slot="start-content"
                        />
                        <t-taxonomy-header key="delete-button">{t('delete-button')}</t-taxonomy-header>
                    </Button>
                    <Button
                        form={
                            type === 'categories' 
                                ? 'category-form' 
                                : type === 'tags' 
                                    ? 'tag-form' 
                                    : ''
                        }
                        variant="solid"
                        color="primary"
                        id="save-taxonomy-entry-btn"
                        type={'submit'}
                    >
                        <Icon
                            name="heroicons:check-circle"
                            width={20}
                            height={20}
                            slot="start-content"
                        />
                        <t-taxonomy-header key="save-button">{t('save-button')}</t-taxonomy-header>
                    </Button>
                </Group>
            )
        }

        {
            mode === 'create' && (
                <Button
                    form={
                        type === 'categories' 
                            ? 'category-form' 
                            : type === 'tags' 
                                ? 'tag-form' 
                                : ''
                    }
                    variant="solid"
                    color="primary"
                    id="create-taxonomy-entry-btn"
                    type={'submit'}
                >
                    <Icon
                        name="heroicons:plus-circle"
                        width={20}
                        height={20}
                        slot="start-content"
                    />
                    <t-taxonomy-header key="create-button">{t('create-button')}</t-taxonomy-header>
                </Button>
            )
        }
    </div>
</header>

<script>
    import {
        $i18n,
        baseTranslation,
        makeTranslation,
    } from "studiocms:i18n/client";

    const currentPage = "@studiocms/dashboard:taxonomy-header";

    const i18n = $i18n(currentPage, baseTranslation[currentPage]);

    const pageDataEl = document.getElementById('page-header-data') as HTMLDivElement;
    const pageTitle = pageDataEl.dataset.pageTitle;
    const type = pageDataEl.dataset.type;
    const mode = pageDataEl.dataset.mode;
    const titleTranslationKey = pageDataEl.dataset.titleTranslationKey;

    const pageTitleEl = document.getElementById('page-title') as HTMLHeadingElement;

    const replaceNameParam = (str: string) => str.replace('{name}', pageTitle || '');

    i18n.subscribe((comp) => {
        if (type && ['categories', 'tags'].includes(type) && mode === 'edit' && titleTranslationKey) {
            pageTitleEl.textContent = replaceNameParam(comp[titleTranslationKey as keyof typeof comp]);
        }
    });

    if (!customElements.get("t-taxonomy-header")) {
        customElements.define("t-taxonomy-header", makeTranslation(currentPage, i18n));
    }
</script>

<script>
    type AllowedTypes = 'categories' | 'tags';
    type FullTypeOptions = 'index' | AllowedTypes;

    class TabsContextUpdater extends HTMLElement {
        #type: FullTypeOptions = 'index';
        #labelToLocalStorageMap = {
            categories: 0,
            tags: 1,
        } as const;
        #allowedTypes: FullTypeOptions[] = ['categories', 'tags'];

        constructor() {
            super();
            this.#type = (this.getAttribute('type') as FullTypeOptions | null) || 'index';

            this.style.display = 'none';
        }

        connectedCallback() {
            if (this.#allowedTypes.includes(this.#type)) {
                this.setTaxonomyLocalStorageValue(this.#type as AllowedTypes);
            }
        }

        setTaxonomyLocalStorageValue(value: AllowedTypes): void {
            const key = 'sui-tabs-taxonomy-selection';
            const mappedValue = this.#labelToLocalStorageMap[value];
            localStorage.setItem(key, mappedValue.toString());
        }
    }

    if (!customElements.get('tabs-context-updater')) {
        customElements.define('tabs-context-updater', TabsContextUpdater);
    }
</script>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title-container {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        width: fit-content;
    }

    .page-title {
        display: block;
        width: fit-content;
        margin: 0;
    }

    .page-actions-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
    }
</style>