---
import { useTranslations } from 'studiocms:i18n';
import { Input } from 'studiocms:ui/components/input';
import MetaContainer from '#frontend/components/dashboard/taxonomy/MetaContainer.astro';
import TaxonomyLayout from '#frontend/layouts/TaxonomyLayout.astro';

const { defaultLang: lang } = Astro.locals.StudioCMS;

const t = useTranslations(lang, '@studiocms/dashboard:taxonomy-index');
---
<TaxonomyLayout type='tags'>
    <form 
        id="tag-form" 
        action={Astro.locals.StudioCMS.routeMap.endpointLinks.taxonomy} 
        method="post"
    >

        <input type="hidden" name="mode" value="create" />
        <input type="hidden" name="id" value="" />

        <div class="form-row">
            <Input name="name" label="Name" isRequired />
            <Input name="slug" label="Slug" isRequired />
        </div>

        <Input
            name="description"
            label="Description"
        />

        <MetaContainer name="meta" />

    </form>
</TaxonomyLayout>

<script>
    import { getCurrentEntryData, parseFormDataToJson } from "./shared-client.js";
    import { toast } from 'studiocms:ui/components/toaster/client';

    const $ = <E extends HTMLElement>(selector: string, context: Document | Element = document) =>
        context.querySelector(selector) as E;

    const dataEl = $("#current-taxonomy-entry-data");
    const modeInput = $<HTMLInputElement>('input[name="mode"]');
    const idInput = $<HTMLInputElement>('input[name="id"]');
    const titleInput = $<HTMLInputElement>('input[name="name"]');
    const slugInput = $<HTMLInputElement>('input[name="slug"]');
    const descriptionInput = $<HTMLInputElement>('input[name="description"]');
    const metaContainer = $<HTMLElement>(
        `dynamic-key-value-pair[name="meta"]`,
    );
    const form = $("#tag-form") as HTMLFormElement;

    const currentData = getCurrentEntryData<"tags">(dataEl);

    function populate() {
        modeInput.value = dataEl.dataset.mode || 'create';
        if (dataEl.dataset.mode === "edit") {
            idInput.value = String(currentData.currentEntry.id || "");
            titleInput.value = currentData.currentEntry.name || "";
            slugInput.value = currentData.currentEntry.slug || "";
            descriptionInput.value = currentData.currentEntry.description || "";
            metaContainer.setAttribute(
                "entries",
                JSON.stringify(currentData.currentEntry.meta || {}),
            );

        }
    }

    function loadForm() {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const jsonData = parseFormDataToJson(formData, 'tags');

            let response: Response;

            try {
                response = await fetch(form.action, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(jsonData),
                });
            } catch (error) {
                toast({
                    title: "Error",
                    description:
                        "An error occurred while saving the tag",
                    type: "danger",
                });
                return;
            }

            if (response.ok) {
                const result: { message: string } =
                    await response.json();
                if (response.status === 200) {
                    toast({
                        title: "Success",
                        description:
                            result.message || "Tag saved successfully",
                        type: "success",
                    });
                } else {
                    toast({
                        title: "Error",
                        description:
                            result.message ||
                            "An error occurred while saving the tag",
                        type: "danger",
                    });
                }
            } else {
                toast({
                    title: "Error",
                    description:
                        "An error occurred while saving the tag",
                    type: "danger",
                });
            }
        })
    }

    document.addEventListener("DOMContentLoaded", () => {
        populate();
        loadForm();
    });
</script>

<style>
    #tag-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    @media (max-width: 600px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>